{"version":3,"sources":["../../../../src/test/startup/server/startup.integration.test.js"],"names":["config","require","runMode","type","StartUp","vHost","Client","s","vh","vh2","c","before","on","data","i","length","write","Buffer","from","Promise","all","start","after","stop","console","log","process","exit","run","x","setInterval","send","CMD","normal","alarm","clearInterval","then","setTimeout"],"mappings":";;AAAA,IAAIA,SAAOC,QAAQ,4BAAR,CAAX;AACAD,OAAOE,OAAP,CAAeC,IAAf,GAAoB,aAApB;AACA,IAAMC,UAAQH,QAAQ,8BAAR,CAAd;AACA,IAAMI,QAAMJ,QAAQ,4BAAR,CAAZ;AACA,IAAMK,SAAOL,QAAQ,iBAAR,CAAb;;AAEA,IAAIM,IAAE,IAAN;AAAA,IAAWC,KAAG,IAAd;AAAA,IAAmBC,MAAI,IAAvB;AAAA,IAA4BC,IAAE,IAA9B;AACA,IAAIC,SAAO,SAAPA,MAAO,GAAI;AACXJ,QAAE,IAAIH,OAAJ,EAAF;AACAI,SAAG,IAAIH,KAAJ,CAAU,CAAV,CAAH;AACAI,UAAI,IAAIJ,KAAJ,CAAU,CAAV,CAAJ;AACAK,QAAE,IAAIJ,MAAJ,CAAW,IAAX,EAAgB,IAAhB,CAAF;AACAI,MAAEE,EAAF,CAAK,MAAL,EAAY,UAACC,IAAD,EAAQ;AAChB,aAAI,IAAIC,IAAE,CAAV,EAAYA,IAAED,KAAKE,MAAnB,EAA0BD,KAAG,CAA7B,EAA+B;AAC3B,gBAAGD,KAAKC,IAAE,CAAP,MAAY,CAAf,EAAiB;AAAC;AACdJ,kBAAEM,KAAF,CAAQC,OAAOC,IAAP,CAAY,kBAAZ,EAA+B,KAA/B,CAAR,EAA+C;AAClD;AACJ;AACJ,KAND;AAOA,WAAOC,QAAQC,GAAR,CAAY,CAACZ,GAAGa,KAAH,EAAD,EAAYd,EAAEc,KAAF,EAAZ,EAAsBZ,IAAIY,KAAJ,EAAtB,CAAZ,CAAP;AACH,CAbD;;AAeA,IAAIC,QAAM,SAANA,KAAM,GAAI;AACVf,MAAEgB,IAAF;AACAb,MAAEa,IAAF;AACAC,YAAQC,GAAR,CAAY,KAAZ;AACAC,YAAQC,IAAR;AACH,CALD;;AAQA,IAAIC,MAAK,SAALA,GAAK,GAAI;AACTlB,MAAEW,KAAF;AACA,QAAIQ,IAAE,CAAN;AACA,QAAIf,IAAEgB,YAAY,YAAI;AAClB,YAAG,EAAED,CAAF,KAAM,CAAT,EAAW;AACPrB,eAAGuB,IAAH,CAAQ1B,MAAM2B,GAAN,CAAUC,MAAlB;AACAxB,gBAAIsB,IAAJ,CAAS1B,MAAM2B,GAAN,CAAUC,MAAnB;AACH;AACD,YAAGJ,MAAI,CAAP,EAAS;AACLrB,eAAGuB,IAAH,CAAQ1B,MAAM2B,GAAN,CAAUE,KAAlB,EAAwB,GAAxB;AACAC,0BAAcrB,CAAd;AACH;AACJ,KATK,EASJ,GATI,CAAN;AAUH,CAbD;;AAeAH,SAASyB,IAAT,CAAcR,GAAd;AACAS,WAAWf,KAAX,EAAiB,KAAjB","file":"startup.integration.test.js","sourcesContent":["let config=require('../../../app/config/config');\r\nconfig.runMode.type='integration';\r\nconst StartUp=require('../../../app/servers/startup');\r\nconst vHost=require('../../../host/virtual_host');\r\nconst Client=require('./client_socket');\r\n\r\nlet s=null,vh=null,vh2=null,c=null;\r\nlet before=()=>{\r\n    s=new StartUp();\r\n    vh=new vHost(1);\r\n    vh2=new vHost(3);\r\n    c=new Client(null,3001);\r\n    c.on('data',(data)=>{\r\n        for(let i=0;i<data.length;i+=8){\r\n            if(data[i+3]===1){//08003001 00000003\r\n                c.write(Buffer.from('0800000000000002','hex'));break;\r\n            }\r\n        }\r\n    });\r\n    return Promise.all([vh.start(),s.start(),vh2.start()]);\r\n};\r\n\r\nlet after=()=>{\r\n    s.stop();\r\n    c.stop();\r\n    console.log('结束了');\r\n    process.exit();\r\n};\r\n\r\n\r\nlet run= ()=>{\r\n    c.start();\r\n    let x=0;\r\n    let i=setInterval(()=>{\r\n        if(++x===1){\r\n            vh.send(vHost.CMD.normal);\r\n            vh2.send(vHost.CMD.normal);\r\n        }\r\n        if(x===3){\r\n            vh.send(vHost.CMD.alarm,120);\r\n            clearInterval(i);\r\n        }\r\n    },400);\r\n};\r\n\r\nbefore().then(run);\r\nsetTimeout(after,15000);"]}