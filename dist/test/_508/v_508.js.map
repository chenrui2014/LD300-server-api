{"version":3,"sources":["../../../src/test/_508/v_508.js"],"names":["expect","require","SerialPort","_","assert","options","autoOpen","_508PTZ","com","_com","cb","port","_port","buffer","Buffer","alloc","write","resp","err","console","error","toString","log","from","receive","data","concat","i","length","slice","ok","equals","equal","xor","resp2","open","on","close","pos","result","x","exports","module"],"mappings":"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","file":"v_508.js","sourcesContent":["/**\r\n * Created by Luky on 2017/7/11.\r\n */\r\n\r\nconst expect = require('chai').expect;\r\nconst SerialPort=require('serialport');\r\nconst _=require('lodash');\r\nconst assert=require('assert');\r\n\r\nlet options={\r\n    \"baudRate\": 9600,\r\n    \"stopBits\": 1,\r\n    \"dataBits\": 8,\r\n    autoOpen: false,\r\n};\r\n\r\nclass _508PTZ{\r\n    constructor(com){\r\n        this._com=com;\r\n    }\r\n    run(cb){\r\n        let port=this._port=new SerialPort(this._com,options);\r\n        let buffer=Buffer.alloc(0);\r\n        function write(resp){\r\n            port.write(resp,function(err){\r\n                if(err) console.error(`V:508转台回执异常:${err},信息${resp.toString('hex')}`);\r\n                console.log(`V:508转台回执成功,命令[${Buffer.from(resp).toString('hex')}]`);\r\n            });\r\n        }\r\n        let receive=(data)=>{\r\n            console.log(`V:虚拟508设备收到命令[${Buffer.from(data).toString('hex')}]`);\r\n            buffer=Buffer.concat([buffer,data]);\r\n            //buffer=Buffer.concat([buffer,data,Buffer.from([0xaf])]);\r\n            while(true) {\r\n                let i = 0;\r\n                while (i < buffer.length && buffer[i] !== 0xA1 && buffer[i] !== 0xA2&&buffer[i] !== 0xFF) {\r\n                    i++;\r\n                }\r\n                if(i>0)buffer=buffer.slice(i);\r\n                //apertureDec a2 00 09 49 4d 00 00 af af\r\n                if(buffer.length===8&&buffer[3]===0x49&&buffer[4]===0x4d){\r\n                    buffer=Buffer.concat([buffer,Buffer.from([0xaf])]);\r\n                }\r\n                if(buffer.length<9&&buffer[i]!==0xFF) return;\r\n                if(buffer[i]===0xFF){\r\n                    assert.ok(Buffer.from(buffer.slice(0,7)).equals(Buffer.from(new Buffer([0xFF,0x01,0x00,0x09,0x00,0x02,45]))));\r\n                    buffer=buffer.slice(7);\r\n                    console.log('V:解析出自动聚焦回执');\r\n                }\r\n\r\n                if(buffer[0]===0xA1&&buffer.length>=0xF){\r\n                    assert.equal(buffer[0xE],0xAF);\r\n\r\n                    if(buffer[3]===0x50&&buffer[4]===0x32){\r\n                        console.log('V:解析出伺服移动指令');\r\n                        let resp=new Buffer([0xA1,0x00,0x0B,0x45,0x60,0x00,0x00,0x00,0x00,0x00,0xAF]);\r\n                        xor(resp,9);\r\n                        write(resp);\r\n                    }\r\n                    buffer=buffer.slice(0xF);\r\n                }\r\n\r\n                if(buffer[0]===0xA1&&buffer.length>=0x0B) {\r\n                    assert.equal(buffer[0xA],0xAF);\r\n\r\n                    if(buffer[3]===0x50&&buffer[4]===0x30){\r\n                        console.log('V:解析出伺服移动指令');\r\n                    }\r\n                    else if(buffer[3]===0x51&&buffer[4]===0x52){\r\n                        console.log('V:解析出查询启动命令');\r\n                    }\r\n                    else if(buffer[3]===0x51&&buffer[4]===0x50){\r\n                        console.log('V:解析出查询位置命令');\r\n                        let resp=new Buffer([0xA1,0x00,0x0B,0x30,0x58,0x00,0x00,0x00,0x01,0x00,0xAF]);\r\n                        xor(resp,9);\r\n                        let resp2=new Buffer([0xA1,0x00,0x0B,0x30,0x59,0x00,0x00,0x00,0x01,0x00,0xAF]);\r\n                        xor(resp2,9);\r\n                        write(Buffer.concat([resp,resp2],22));\r\n                    }\r\n                    buffer=buffer.slice(0xB);\r\n                }\r\n\r\n                if(buffer[i]===0xA2&&buffer.length>=9){\r\n                    assert.equal(buffer[8],0xAF);\r\n                    console.log(`V:解析出白光命令`);\r\n                    let resp=buffer.slice(0,9);\r\n                    resp[5]=0;resp[6]=0;\r\n                    xor(resp,7);\r\n                    write(resp);\r\n                    buffer=buffer.slice(9);\r\n                }\r\n            }\r\n        };\r\n        port.open((err)=>{\r\n            if(err){cb(err);console.error(`V:端口打开异常：${err}`);return;}\r\n            console.log('V:虚拟508设备已打开');\r\n            //const parser = port.pipe(new Delimiter({ delimiter:[0xAF] }));\r\n            //const parser = port.pipe(new Delimiter());\r\n            port.on('data', receive);\r\n            cb();\r\n        });\r\n    }\r\n    stop(cb){\r\n        this._port.close((err)=>{\r\n            if(err){console.error(`V:端口关闭异常：${err}`);cb(err);return;}\r\n            cb();\r\n            console.log('V:虚拟508设备已关闭');\r\n        });\r\n    }\r\n}\r\n\r\nfunction xor(buffer,pos){\r\n    let result=buffer[0];\r\n    for(let x=1;x<pos;x++){\r\n        result=result^buffer[x];\r\n    }\r\n    buffer[pos]=result;\r\n}\r\n\r\nexports=module.exports=_508PTZ;"]}