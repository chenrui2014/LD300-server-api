{"version":3,"sources":["../../../src/test/dahua/dhnetsdk.test.js"],"names":["ffi","require","dhlib","ref","_","ArrayType","expect","fs","ip","port","name","pwd","channel","Struct","H264unPack","PassThrough","wOption","flags","encoding","fd","mode","autoClose","describe","loginID","before","result","functions","CLIENT_Init","callbacks","fDisConnect","loginid","string","dwuser","console","log","equal","err","alloc","NET_DEVICEINFO_Ex","structs","CLIENT_LoginEx2","NULL","not","actualerr","deref","after","CLIENT_Logout","CLIENT_Cleanup","it","done","fw","createWriteStream","fw2","pack","p","pipe","callback","fRealDataCallBackEx","rid","dataType","buf","size","param","out","readPointer","write","toString","playID","CLIENT_RealPlayEx","enums","playType","Realplay_1","error","CLIENT_GetLastError","saved","CLIENT_SaveRealData","cbok","CLIENT_SetRealDataCallBackEx","setTimeout","CLIENT_StopRealPlayEx","close","logoutStruct","struct","data","each","toObject","val","key","fields","type","buffer","readCString","xit","s","Buffer","DEV_ENCODER_INFO","ok","CLIENT_QueryDecEncoderInfo","sv","st","DH_DEV_ENABLE_INFO","nLenRet","CLIENT_QuerySystemInfo","DH_SYS_ABILITY","DEVALL_INFO","code","allocCString","CLIENT_GetNewDevConfig","lst","TALKFORMAT_LIST","CLIENT_QueryDevState","consts","DEVSTATE_TALK_ECTYPE","i","nSupportNum","lsti","nAudioBit","dwSampleRate","encodeType","CLIENT_SetDeviceMode","EM_USEDEV_MODE","DH_TALK_SERVER_MODE","en","TALKDECODE_INFO","TALK_CODING_TYPE","AAC","TALK_ENCODE_TYPE","sp","NET_SPEAK_PARAM","dwSize","nMode","nSpeakerChannel","bEnableWait","TALK_SPEAK_PARAM","ttp","NET_TALK_TRANSFER_PARAM","bTransfer","DH_TALK_TRANSFER_MODE","ap","ALARMCTRL_PARAM","nAlarmNo","nAction","CLIENT_ControlDevice","DH_DEV_IPC_INFO","bok","DH_DEVSTATE_IPC","ct","nTypeCount","spt","bSupportTypes","IPC_TYPE","get","CLIENT_DHPTZControl","PTZ","PTZ_ZOOM_ADD"],"mappings":";;;;;;;;;;AAAA;;;AAGA,IAAMA,MAAIC,QAAQ,KAAR,CAAV;AACA,IAAMC,QAAMD,QAAQ,2BAAR,CAAZ;AACA,IAAME,MAAIF,QAAQ,KAAR,CAAV;AACA,IAAMG,IAAEH,QAAQ,QAAR,CAAR;AACA,IAAMI,YAAUJ,QAAQ,WAAR,CAAhB;AACA,IAAMK,SAASL,QAAQ,MAAR,EAAgBK,MAA/B;AACA,IAAMC,KAAKN,QAAQ,IAAR,CAAX;AACA;AACA,IAAMO,KAAG,cAAT;AAAA,IAAwBC,OAAK,OAA7B;AAAA,IAAqCC,OAAK,OAA1C;AAAA,IAAkDC,MAAI,OAAtD;AAAA,IAA8DC,UAAQ,CAAtE;AACA;AACA;AACA,IAAMC,SAASZ,QAAQ,YAAR,CAAf;AACA,IAAMa,aAAWb,QAAQ,kCAAR,CAAjB;AACA,IAAMc,cAAYd,QAAQ,QAAR,EAAkBc,WAApC;;AAEA,IAAMC,UAAU;AACZC,WAAO,GADK;AAEZC,cAAU,IAFE;AAGZC,QAAI,IAHQ;AAIZC,UAAM,GAJM;AAKZC,eAAW;AALC,CAAhB;;AASAC,SAAS,MAAT,EAAiB,YAAW;AAAA;;AAExB,QAAIC,gBAAJ;AACAC,WAAO,YAAY;AACf,YAAIC,SAAOvB,MAAMwB,SAAN,CAAgBC,WAAhB,CAA4BzB,MAAM0B,SAAN,CAAgBC,WAAhB,CAA4B,UAASC,OAAT,EAAiBC,MAAjB,EAAwBtB,IAAxB,EAA6BuB,MAA7B,EAAoC;AACnGC,oBAAQC,GAAR,CAAY,gBAAZ;AACH,SAFsC,CAA5B,EAER,CAFQ,CAAX;AAGA5B,eAAOmB,MAAP,EAAeU,KAAf,CAAqB,CAArB;AACA,YAAIC,MAAIjC,IAAIkC,KAAJ,CAAU,KAAV,CAAR;AACA,YAAIC,oBAAkB,IAAIpC,MAAMqC,OAAN,CAAcD,iBAAlB,EAAtB;AACAf,kBAAQrB,MAAMwB,SAAN,CAAgBc,eAAhB,CAAgChC,EAAhC,EAAmCC,IAAnC,EAAwCC,IAAxC,EAA6CC,GAA7C,EAAiD,CAAjD,EAAmDR,IAAIsC,IAAvD,EAA4DH,kBAAkBnC,GAAlB,EAA5D,EAAoFiC,GAApF,CAAR;AACA;AACA;AACA9B,eAAOiB,OAAP,EAAgBmB,GAAhB,CAAoBP,KAApB,CAA0B,CAA1B;AACA,YAAIQ,YAAWP,IAAIQ,KAAJ,EAAf;AACAtC,eAAOqC,SAAP,EAAkBR,KAAlB,CAAwB,CAAxB;AACA;AACA;AACH,KAfD;;AAiBAU,UAAM,YAAY;AACd3C,cAAMwB,SAAN,CAAgBoB,aAAhB,CAA8BvB,OAA9B;AACArB,cAAMwB,SAAN,CAAgBqB,cAAhB;AACH,KAHD;;AAKAC,OAAG,gCAAH,EAAoC,UAASC,IAAT,EAAc;AAC9C,YAAIC,KAAG3C,GAAG4C,iBAAH,CAAqB,sBAArB,EAA4CnC,OAA5C,CAAP;AACA,YAAIoC,MAAI7C,GAAG4C,iBAAH,CAAqB,6BAArB,EAAmDnC,OAAnD,CAAR;AACA,YAAIqC,OAAK,IAAIvC,UAAJ,EAAT;AACA,YAAIwC,IAAE,IAAIvC,WAAJ,EAAN;AACA;AACAsC,aAAKE,IAAL,CAAUD,CAAV;AACAA,UAAEC,IAAF,CAAOH,GAAP;AACA;;;;AAIR;;;;;;AAMQ,YAAII,WAAStD,MAAM0B,SAAN,CAAgB6B,mBAAhB,CAAoC,UAASC,GAAT,EAAaC,QAAb,EAAsBC,GAAtB,EAA0BC,IAA1B,EAA+BC,KAA/B,EAAqC9B,MAArC,EAA4C;AACzF;AACA,gBAAI+B,MAAI5D,IAAI6D,WAAJ,CAAgBJ,IAAIzD,GAAJ,EAAhB,EAA0B,CAA1B,EAA4B0D,IAA5B,CAAR;AACAX,eAAGe,KAAH,CAASF,GAAT;AACA9B,oBAAQC,GAAR,CAAY2B,IAAZ;AACA5B,oBAAQC,GAAR,CAAY6B,IAAIG,QAAJ,CAAa,KAAb,CAAZ;AACA;AACA;AACH,SARY,CAAb;AASA,YAAIC,SAAOjE,MAAMwB,SAAN,CAAgB0C,iBAAhB,CAAkC7C,OAAlC,EAA0CX,OAA1C,EAAkDT,IAAIsC,IAAtD,EAA2DvC,MAAMmE,KAAN,CAAYC,QAAZ,CAAqBC,UAAhF,CAAX;AACA,YAAG,CAACJ,MAAJ,EAAW;AACPlC,oBAAQuC,KAAR,CAActE,MAAMwB,SAAN,CAAgB+C,mBAAhB,KAAuC,UAArD;AACH;AACD,YAAIC,QAAMxE,MAAMwB,SAAN,CAAgBiD,mBAAhB,CAAoCR,MAApC,EAA2C,aAA3C,CAAV;;AAEA,YAAIS,OAAK1E,MAAMwB,SAAN,CAAgBmD,4BAAhB,CAA6CV,MAA7C,EAAoDX,QAApD,EAA6D,CAA7D,EAA+D,IAA/D,CAAT;AACAlD,eAAOsE,IAAP,EAAalC,GAAb,CAAiBP,KAAjB,CAAuB,CAAvB;;AAEP;;;;AAIO7B,eAAO6D,MAAP,EAAezB,GAAf,CAAmBP,KAAnB,CAAyB,CAAzB;;AAEA2C,mBAAW,YAAI;AACX5E,kBAAMwB,SAAN,CAAgBqD,qBAAhB,CAAsCZ,MAAtC;AACAjB,eAAG8B,KAAH;AACAxB;AACAJ,gBAAI4B,KAAJ;AACA;AACA/B;AACH,SAPD,EAOE,KAPF;AAQH,KAlDD;;AAoDA,aAASgC,YAAT,CAAsBC,MAAtB,EAA6BC,IAA7B,EAAkC;AAC9B/E,UAAEgF,IAAF,CAAOD,KAAKE,QAAL,EAAP,EAAuB,UAACC,GAAD,EAAKC,GAAL,EAAW;AAC9B,gBAAGL,OAAOM,MAAP,CAAcD,GAAd,EAAmBE,IAAnB,CAAwB/E,IAAxB,KAA+B,WAA/B,IACGwE,OAAOM,MAAP,CAAcD,GAAd,EAAmBE,IAAnB,CAAwBA,IAAxB,CAA6B/E,IAA7B,KAAoC,MAD1C,EACiD;AAC7CuB,wBAAQC,GAAR,CAAeqD,GAAf,SAAsBD,IAAII,MAAJ,CAAWC,WAAX,CAAuB,CAAvB,CAAtB;AACH,aAHD,MAIK;AACD1D,wBAAQC,GAAR,CAAeqD,GAAf,SAAsBD,GAAtB;AACH;AACJ,SARD;AASH;;AAEDM,QAAI,oCAAJ,EAAyC,YAAU;AAC/C,YAAIC,IAAEC,OAAOzD,KAAP,CAAanC,MAAMqC,OAAN,CAAcwD,gBAAd,CAA+BlC,IAA5C,CAAN;AACAgC,UAAEJ,IAAF,GAAOvF,MAAMqC,OAAN,CAAcwD,gBAArB;AACA,YAAIC,KAAG9F,MAAMwB,SAAN,CAAgBuE,0BAAhB,CAA2C1E,OAA3C,EAAmD,CAAnD,EAAqD,CAArD,EAAuD,IAAvD,CAAP;AACA,YAAG,CAACyE,EAAJ,EAAO;AACH/D,oBAAQuC,KAAR,CAActE,MAAMwB,SAAN,CAAgB+C,mBAAhB,KAAyC,UAAvD;AACH;AACD,YAAIyB,KAAG,IAAIhG,MAAMqC,OAAN,CAAcwD,gBAAlB,CAAmCF,CAAnC,CAAP;AACAZ,qBAAa/E,MAAMqC,OAAN,CAAcwD,gBAA3B,EAA4CG,EAA5C;AACA;AACA;AACA5F,eAAO0F,EAAP,EAAW7D,KAAX,CAAiB,CAAjB;AACH,KAZD;;AAcAyD,QAAI,8BAAJ,EAAmC,YAAI;AACnC,YAAIO,KAAGjG,MAAMqC,OAAN,CAAc6D,kBAArB;AACA,YAAIA,qBAAmB,IAAID,EAAJ,EAAvB;AACA,YAAIE,UAAQlG,IAAIkC,KAAJ,CAAU,KAAV,CAAZ;AACA,YAAI2D,KAAG9F,MAAMwB,SAAN,CAAgB4E,sBAAhB,CAAuC/E,OAAvC,EAA+CrB,MAAMmE,KAAN,CAAYkC,cAAZ,CAA2BC,WAA1E,EAAsFJ,mBAAmBjG,GAAnB,EAAtF,EAA+GgG,GAAGtC,IAAlH,EAAuHwC,OAAvH,EAA+H,IAA/H,CAAP;AACA,YAAG,CAACL,EAAJ,EAAO;AACH/D,oBAAQuC,KAAR,CAActE,MAAMwB,SAAN,CAAgB+C,mBAAhB,KAAyC,UAAvD;AACH;AACD4B,kBAAQA,QAAQzD,KAAR,EAAR;AACAtC,eAAO0F,EAAP,EAAW7D,KAAX,CAAiB,CAAjB;AACA7B,eAAO+F,OAAP,EAAgBlE,KAAhB,CAAsBgE,GAAGtC,IAAzB;AACAoB,qBAAakB,EAAb,EAAgBC,kBAAhB;AACA;AACA;AACH,KAdD;;AAgBAR,QAAI,8BAAJ,EAAmC,YAAI;AACnC,YAAI/B,OAAK3D,MAAMqC,OAAN,CAAcwD,gBAAd,CAA+BlC,IAAxC;AACA,YAAI6B,SAAO,IAAII,MAAJ,CAAWjC,IAAX,CAAX;AACA,YAAIzB,MAAIjC,IAAIkC,KAAJ,CAAU,KAAV,CAAR;AACA,YAAIoE,OAAOtG,IAAIuG,YAAJ,CAAiB,KAAjB,CAAX;AACA,YAAIV,KAAG9F,MAAMwB,SAAN,CAAgBiF,sBAAhB,CAAuCpF,OAAvC,EAA+CkF,KAAKtG,GAAL,EAA/C,EAA0D,CAA1D,EAA4DuF,MAA5D,EAAmE7B,IAAnE,EAAwEzB,GAAxE,EAA4E,GAA5E,CAAP;AACA,YAAG,CAAC4D,EAAJ,EAAO;AACH/D,oBAAQuC,KAAR,CAActE,MAAMwB,SAAN,CAAgB+C,mBAAhB,KAAyC,UAAvD;AACH;AACD,YAAI9B,YAAWP,IAAIQ,KAAJ,EAAf;AACAtC,eAAO0F,EAAP,EAAW7D,KAAX,CAAiB,CAAjB;AACA7B,eAAOqC,SAAP,EAAkBR,KAAlB,CAAwB,CAAxB;AACA,YAAI+D,KAAG,IAAIhG,MAAMqC,OAAN,CAAcwD,gBAAlB,CAAmCL,MAAnC,CAAP;AACAT,qBAAa/E,MAAMqC,OAAN,CAAcwD,gBAA3B,EAA4CG,EAA5C;AACH,KAdD;;AAgBAN,QAAI,0BAAJ,EAA+B,YAAI;AAC/B,YAAIgB,MAAI,IAAI1G,MAAMqC,OAAN,CAAcsE,eAAlB,EAAR;AACA,YAAIR,UAAQlG,IAAIkC,KAAJ,CAAU,KAAV,CAAZ;AACA,YAAI2D,KAAG9F,MAAMwB,SAAN,CAAgBoF,oBAAhB,CAAqCvF,OAArC,EAA6CrB,MAAM6G,MAAN,CAAaC,oBAA1D,EAA+EJ,IAAIzG,GAAJ,EAA/E,EAAyFD,MAAMqC,OAAN,CAAcsE,eAAd,CAA8BhD,IAAvH,EAA4HwC,OAA5H,EAAoI,IAApI,CAAP;AACA,YAAG,CAACL,EAAJ,EAAO;AACH/D,oBAAQC,GAAR,CAAYhC,MAAMwB,SAAN,CAAgB+C,mBAAhB,KAAwC,UAApD;AACH;AACDnE,eAAO,CAAC0F,EAAR,EAAY7D,KAAZ,CAAkB,KAAlB;AACA7B,eAAO+F,QAAQzD,KAAR,EAAP,EAAwBT,KAAxB,CAA8BjC,MAAMqC,OAAN,CAAcsE,eAAd,CAA8BhD,IAA5D;AACA,aAAI,IAAIoD,IAAE,CAAV,EAAYA,IAAEL,IAAIM,WAAlB,EAA8BD,GAA9B,EAAkC;AAC9B,gBAAIE,OAAKP,IAAInB,IAAJ,CAASwB,CAAT,CAAT;AACAhF,oBAAQC,GAAR,eAAwBiF,KAAKC,SAA7B,cAA+CD,KAAKE,YAApD,gBAA2EF,KAAKG,UAAhF;AACH;AACD;;;;;;;;;AASA;AACH,KAvBD;;AAyBA1B,QAAI,6BAAJ,EAAkC,YAAI;AAClC,YAAII,KAAG9F,MAAMwB,SAAN,CAAgB6F,oBAAhB,CAAqChG,OAArC,EAA6CrB,MAAMmE,KAAN,CAAYmD,cAAZ,CAA2BC,mBAAxE,EAA4FtH,IAAIsC,IAAhG,CAAP;AACAnC,eAAO,CAAC0F,EAAR,EAAY7D,KAAZ,CAAkB,KAAlB;AACA,YAAIuF,KAAGxH,MAAMqC,OAAN,CAAcoF,eAAd,CAA8B;AACjC,0BAAazH,MAAMmE,KAAN,CAAYuD,gBAAZ,CAA6BC,GADT;AAEjC,yBAAY,CAFqB;AAGjC,4BAAe;AAHkB,SAA9B,CAAP;AAKA7B,aAAG9F,MAAMwB,SAAN,CAAgB6F,oBAAhB,CAAqChG,OAArC,EAA6CrB,MAAMmE,KAAN,CAAYmD,cAAZ,CAA2BM,gBAAxE,EAAyFJ,GAAGvH,GAAH,EAAzF,CAAH;AACAG,eAAO,CAAC0F,EAAR,EAAY7D,KAAZ,CAAkB,KAAlB;AACA,YAAI4F,KAAG,IAAI7H,MAAMqC,OAAN,CAAcyF,eAAlB,CAAkC;AACrCC,oBAAO/H,MAAMqC,OAAN,CAAcyF,eAAd,CAA8BnE,IADA;AAErCqE,mBAAM,CAF+B;AAGrCC,6BAAgB,CAHqB;AAIrCC,yBAAY;AAJyB,SAAlC,CAAP;AAMApC,aAAG9F,MAAMwB,SAAN,CAAgB6F,oBAAhB,CAAqChG,OAArC,EAA6CrB,MAAMmE,KAAN,CAAYmD,cAAZ,CAA2Ba,gBAAxE,EAAyFN,GAAG5H,GAAH,EAAzF,CAAH;AACA,YAAImI,MAAI,IAAIpI,MAAMqC,OAAN,CAAcgG,uBAAlB,CAA0C;AAC9CN,oBAAO/H,MAAMqC,OAAN,CAAcgG,uBAAd,CAAsC1E,IADC;AAE9C2E,uBAAU;AAFoC,SAA1C,CAAR;AAIAlI,eAAO,CAAC0F,EAAR,EAAY7D,KAAZ,CAAkB,KAAlB;AACA6D,aAAG9F,MAAMwB,SAAN,CAAgB6F,oBAAhB,CAAqChG,OAArC,EAA6CrB,MAAMmE,KAAN,CAAYmD,cAAZ,CAA2BiB,qBAAxE,EAA8FH,IAAInI,GAAJ,EAA9F,CAAH;AACAG,eAAO,CAAC0F,EAAR,EAAY7D,KAAZ,CAAkB,KAAlB;AACH,KAxBD;;AA0BAyD,QAAI,MAAJ,EAAW,UAAC3C,IAAD,EAAQ;AACf,YAAIyF,KAAK,IAAIxI,MAAMqC,OAAN,CAAcoG,eAAlB,CAAkC;AACvCV,oBAAQ/H,MAAMqC,OAAN,CAAcoG,eAAd,CAA8B9E,IADC;AAEvC+E,sBAAU,CAF6B;AAGvCC,qBAAS;AAH8B,SAAlC,CAAT;AAKA;AACA,YAAI7C,KAAG9F,MAAMwB,SAAN,CAAgBoH,oBAAhB,CAAqCvH,OAArC,EAA6C,GAA7C,EAAiDmH,GAAGvI,GAAH,EAAjD,EAA2D,IAA3D,CAAP;AACAG,eAAO0F,EAAP,EAAW7D,KAAX,CAAiB,CAAjB;AACA2C,mBAAW7B,IAAX,EAAgB,IAAhB;AACH,KAVD;;AAYA2C,QAAI,6BAAJ,EAAkC,YAAY;AAC1C,YAAIS,UAAQlG,IAAIkC,KAAJ,CAAU,KAAV,CAAZ;AACA,YAAI0G,kBAAgB,IAAI7I,MAAMqC,OAAN,CAAcwG,eAAlB,EAApB;AACA;AACA,YAAIrD,SAAOvF,IAAIkC,KAAJ,CAAUnC,MAAMqC,OAAN,CAAcwG,eAAxB,CAAX;AACA,YAAIC,MAAI9I,MAAMwB,SAAN,CAAgBoF,oBAAhB,CACJvF,OADI,EAEJrB,MAAM6G,MAAN,CAAakC,eAFT,EAGJF,gBAAgB5I,GAAhB,EAHI,EAIJD,MAAMqC,OAAN,CAAcwG,eAAd,CAA8BlF,IAJ1B,EAKJwC,OALI,EAMJ,IANI,CAAR;AAOA,YAAG,CAAC2C,GAAJ,EAAQ;AACJ/G,oBAAQuC,KAAR,CAActE,MAAMwB,SAAN,CAAgB+C,mBAAhB,KAAyC,UAAvD;AACH;AACDnE,eAAO0I,GAAP,EAAY7G,KAAZ,CAAkB,CAAlB;AACA7B,eAAO+F,QAAQzD,KAAR,EAAP,EAAwBT,KAAxB,CAA8BjC,MAAMqC,OAAN,CAAcwG,eAAd,CAA8BlF,IAA5D;AACAoB,qBAAa/E,MAAMqC,OAAN,CAAcwG,eAA3B,EAA2CA,eAA3C;AACP;;;;;;;;;;;;AAYO,YAAIG,KAAGH,gBAAgB1D,QAAhB,GAA2B8D,UAAlC;AACA,YAAIC,MAAIL,gBAAgB1D,QAAhB,GAA2BgE,aAAnC;AACA,aAAI,IAAIpC,IAAE,CAAV,EAAYA,IAAEiC,EAAd,EAAiBjC,GAAjB,EAAqB;AACjBhF,oBAAQC,GAAR,CAAYhC,MAAMmE,KAAN,CAAYiF,QAAZ,CAAqBC,GAArB,CAAyBH,IAAInC,CAAJ,CAAzB,EAAiC1B,GAA7C;AACH;AACJ,KAnCD;;AAqCAvC,OAAG,eAAH,6DAAmB;AAAA;AAAA;AAAA;AAAA;AACd,4BAAG,CAAC9C,MAAMwB,SAAN,CAAgB8H,mBAAhB,CAAoCjI,OAApC,EAA4C,CAA5C,EAA8CrB,MAAMmE,KAAN,CAAYoF,GAAZ,CAAgBC,YAA9D,EAA2E,CAA3E,EAA6E,CAA7E,EAA+E,CAA/E,EAAiF,CAAjF,CAAD,IAAsF,CAACxJ,MAAMwB,SAAN,CAAgB8H,mBAAhB,CAAoCjI,OAApC,EAA4C,CAA5C,EAA8CrB,MAAMmE,KAAN,CAAYoF,GAAZ,CAAgBC,YAA9D,EAA2E,CAA3E,EAA6E,CAA7E,EAA+E,CAA/E,EAAiF,CAAjF,CAA1F,EAA8K;AAC3KzH,oCAAQuC,KAAR,CAActE,MAAMwB,SAAN,CAAgB+C,mBAAhB,KAAyC,UAAvD;AACH;;AAHc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAnB;AAKH,CAhPD","file":"dhnetsdk.test.js","sourcesContent":["/**\r\n * Created by Luky on 2017/6/30.\r\n */\r\nconst ffi=require('ffi');\r\nconst dhlib=require('../../ipcs/dahua/dhnetsdk');\r\nconst ref=require('ref');\r\nconst _=require('lodash');\r\nconst ArrayType=require('ref-array');\r\nconst expect = require('chai').expect;\r\nconst fs = require('fs');\r\n//const ip='192.168.1.106',port='37777',name='admin',pwd='888888',channel=0;\r\nconst ip='192.168.1.98',port='37777',name='admin',pwd='admin',channel=0;\r\n//const ip='192.168.1.200',port='37777',name='admin',pwd='888888',channel=2;\r\n//const ip='192.168.1.200',port='37777',name='admin',pwd='888888',channel=3;//大华摄像头用onvif连接拉取视频流无效\r\nconst Struct = require('ref-struct');\r\nconst H264unPack=require('../../ipcs/dahua/_dh_h264_unpack');\r\nconst PassThrough=require('stream').PassThrough;\r\n\r\nconst wOption = {\r\n    flags: 'w',\r\n    encoding: null,\r\n    fd: null,\r\n    mode: 0o666,\r\n    autoClose: false\r\n};\r\n\r\n\r\ndescribe('函数测试', function() {\r\n\r\n    let loginID;\r\n    before(function () {\r\n        let result=dhlib.functions.CLIENT_Init(dhlib.callbacks.fDisConnect(function(loginid,string,port,dwuser){\r\n            console.log('nvr disconnect');\r\n        }),0);\r\n        expect(result).equal(1);\r\n        let err=ref.alloc('int');\r\n        let NET_DEVICEINFO_Ex=new dhlib.structs.NET_DEVICEINFO_Ex();\r\n        loginID=dhlib.functions.CLIENT_LoginEx2(ip,port,name,pwd,0,ref.NULL,NET_DEVICEINFO_Ex.ref(),err);\r\n        //let NET_DEVICEINFO=new dhlib.structs.NET_DEVICEINFO();\r\n        //loginID=dhlib.functions.CLIENT_Login(ip,port,name,pwd,NET_DEVICEINFO.ref(),err);\r\n        expect(loginID).not.equal(0);\r\n        let actualerr= err.deref();\r\n        expect(actualerr).equal(0);\r\n        //logoutStruct(dhlib.structs.NET_DEVICEINFO_Ex,NET_DEVICEINFO_Ex);\r\n        //logoutStruct(dhlib.structs.NET_DEVICEINFO,NET_DEVICEINFO);\r\n    });\r\n\r\n    after(function () {\r\n        dhlib.functions.CLIENT_Logout(loginID);\r\n        dhlib.functions.CLIENT_Cleanup();\r\n    });\r\n\r\n    it('CLIENT_RealPlayEx视频流播放-分出H264流',function(done){\r\n        let fw=fs.createWriteStream('d:/dhipc_cache1.h264',wOption);\r\n        let fw2=fs.createWriteStream('d:/dhipc_unpacked_fps10.dat',wOption);\r\n        let pack=new H264unPack();\r\n        let p=new PassThrough();\r\n        //pack.setEncoding('ascii');\r\n        pack.pipe(p);\r\n        p.pipe(fw2);\r\n        /*pack.on('data',(data)=>{\r\n            console.log(data.toString('hex'));\r\n        });*/\r\n        \r\n/*        let decCB=dhlib.callbacks.fDecCallBack(function (lid,pid,dec,dec2) {\r\n            console.log(lid);\r\n        });\r\n\r\n        dhlib.functions.CLIENT_SetDecCallBack(decCB,0,0);*/\r\n\r\n        let callback=dhlib.callbacks.fRealDataCallBackEx(function(rid,dataType,buf,size,param,dwuser){\r\n            //param无意义\r\n            let out=ref.readPointer(buf.ref(),0,size)\r\n            fw.write(out);\r\n            console.log(size);\r\n            console.log(out.toString('hex'));\r\n            //pack.write(out);\r\n            //fw2.write(out.toString('hex'));\r\n        });\r\n        let playID=dhlib.functions.CLIENT_RealPlayEx(loginID,channel,ref.NULL,dhlib.enums.playType.Realplay_1);\r\n        if(!playID){\r\n            console.error(dhlib.functions.CLIENT_GetLastError()&(0x7fffffff));\r\n        }\r\n        let saved=dhlib.functions.CLIENT_SaveRealData(playID,'d:\\\\dh.h264');\r\n\r\n        let cbok=dhlib.functions.CLIENT_SetRealDataCallBackEx(playID,callback,0,0x1f);\r\n        expect(cbok).not.equal(0);\r\n\r\n /*       let cbdc=dhlib.callbacks.fRealPlayDisConnect(function(){\r\n            console.error('display disconnect')\r\n        });\r\n        let playID=dhlib.functions.CLIENT_StartRealPlay(loginID,channel,ref.NULL,dhlib.enums.playType.Realplay,callback,cbdc,0,10000);*/\r\n        expect(playID).not.equal(0);\r\n\r\n        setTimeout(()=>{\r\n            dhlib.functions.CLIENT_StopRealPlayEx(playID);\r\n            fw.close();\r\n            callback;\r\n            fw2.close();\r\n            //pack.end();\r\n            done();\r\n        },10000);\r\n    });\r\n\r\n    function logoutStruct(struct,data){\r\n        _.each(data.toObject(),(val,key)=>{\r\n            if(struct.fields[key].type.name==='ArrayType'\r\n                &&struct.fields[key].type.type.name==='char'){\r\n                console.log(`${key}:${val.buffer.readCString(0)}`);\r\n            }\r\n            else {\r\n                console.log(`${key}:${val}`);\r\n            }\r\n        });\r\n    }\r\n\r\n    xit('CLIENT_QueryDecEncoderInfo查询远程设备信息',function(){\r\n        let s=Buffer.alloc(dhlib.structs.DEV_ENCODER_INFO.size);\r\n        s.type=dhlib.structs.DEV_ENCODER_INFO;\r\n        let ok=dhlib.functions.CLIENT_QueryDecEncoderInfo(loginID,0,2,1000);\r\n        if(!ok){\r\n            console.error(dhlib.functions.CLIENT_GetLastError() & (0x7fffffff));\r\n        }\r\n        let sv=new dhlib.structs.DEV_ENCODER_INFO(s);\r\n        logoutStruct(dhlib.structs.DEV_ENCODER_INFO,sv);\r\n        //sv.szDevIp.buffer.readCString(0)\r\n        //sv.toObject()\r\n        expect(ok).equal(1);\r\n    });\r\n\r\n    xit('CLIENT_QuerySystemInfo设备能力查询',()=>{\r\n        let st=dhlib.structs.DH_DEV_ENABLE_INFO;\r\n        let DH_DEV_ENABLE_INFO=new st();\r\n        let nLenRet=ref.alloc('int');\r\n        let ok=dhlib.functions.CLIENT_QuerySystemInfo(loginID,dhlib.enums.DH_SYS_ABILITY.DEVALL_INFO,DH_DEV_ENABLE_INFO.ref(),st.size,nLenRet,1000);\r\n        if(!ok){\r\n            console.error(dhlib.functions.CLIENT_GetLastError() & (0x7fffffff));\r\n        }\r\n        nLenRet=nLenRet.deref();\r\n        expect(ok).equal(1);\r\n        expect(nLenRet).equal(st.size);\r\n        logoutStruct(st,DH_DEV_ENABLE_INFO);\r\n        //摄像头3,3,1,7,1,1,1,1,0,0  ,0,0,0,1,0,0,1,0,0,1  ,5, 0,0,1,2,3,0,0,1, 22,  8, 1,0,0,0,0,0,1,0,0,1   ,0,1,0,0,0,0,0,0,0,1,  0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\r\n        //NVR  :3,7,1,5,0,1,1,0,0,0  ,0,0,0,0,0,0,1,0,0,1  ,7,10,0,1,2,0,0,0,1,175,  17,0,1,0,1,0,3,1,0,1,1   ,1,0,0,0,0,0,0,0,0,0,  0,0,1,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\r\n    });\r\n\r\n    xit('CLIENT_GetNewDevConfig查询编码能力',()=>{\r\n        let size=dhlib.structs.DEV_ENCODER_INFO.size;\r\n        let buffer=new Buffer(size);\r\n        let err=ref.alloc('int');\r\n        let code = ref.allocCString('Ptz');\r\n        let ok=dhlib.functions.CLIENT_GetNewDevConfig(loginID,code.ref(),1,buffer,size,err,500);\r\n        if(!ok){\r\n            console.error(dhlib.functions.CLIENT_GetLastError() & (0x7fffffff))\r\n        }\r\n        let actualerr= err.deref();\r\n        expect(ok).equal(1);\r\n        expect(actualerr).equal(0);\r\n        let sv=new dhlib.structs.DEV_ENCODER_INFO(buffer);\r\n        logoutStruct(dhlib.structs.DEV_ENCODER_INFO,sv);\r\n    });\r\n\r\n    xit('TALKFORMAT_LIST支持的音频编码格式',()=>{\r\n        let lst=new dhlib.structs.TALKFORMAT_LIST();\r\n        let nLenRet=ref.alloc('int');\r\n        let ok=dhlib.functions.CLIENT_QueryDevState(loginID,dhlib.consts.DEVSTATE_TALK_ECTYPE,lst.ref(),dhlib.structs.TALKFORMAT_LIST.size,nLenRet,1000);\r\n        if(!ok){\r\n            console.log(dhlib.functions.CLIENT_GetLastError()& (0x7fffffff));\r\n        }\r\n        expect(!ok).equal(false);\r\n        expect(nLenRet.deref()).equal(dhlib.structs.TALKFORMAT_LIST.size);\r\n        for(let i=0;i<lst.nSupportNum;i++){\r\n            let lsti=lst.type[i];\r\n            console.log(`AudioBit:${lsti.nAudioBit},Rate:${lsti.dwSampleRate},encode:${lsti.encodeType}`);\r\n        }\r\n        /*AudioBit:16,Rate:8000,encode:1 PCM\r\n        AudioBit:16,Rate:16000,encode:1\r\n        AudioBit:16,Rate:8000,encode:2 DH_TALK_G711a\r\n        AudioBit:16,Rate:16000,encode:2\r\n        AudioBit:16,Rate:8000,encode:4 DH_TALK_G711u\r\n        AudioBit:16,Rate:16000,encode:4\r\n        AudioBit:16,Rate:8000,encode:5 DH_TALK_G726\r\n        AudioBit:16,Rate:8000,encode:8 DH_TALK_AAC\r\n        AudioBit:16,Rate:16000,encode:8*/\r\n        //console.log(lst.toObject());\r\n    });\r\n\r\n    xit('CLIENT_SetDeviceMode设置服务端对讲',()=>{\r\n        let ok=dhlib.functions.CLIENT_SetDeviceMode(loginID,dhlib.enums.EM_USEDEV_MODE.DH_TALK_SERVER_MODE,ref.NULL);\r\n        expect(!ok).equal(false);\r\n        let en=dhlib.structs.TALKDECODE_INFO({\r\n            'encodeType':dhlib.enums.TALK_CODING_TYPE.AAC,\r\n            'nAudioBit':8,\r\n            'dwSampleRate':16000\r\n        });\r\n        ok=dhlib.functions.CLIENT_SetDeviceMode(loginID,dhlib.enums.EM_USEDEV_MODE.TALK_ENCODE_TYPE,en.ref());\r\n        expect(!ok).equal(false);\r\n        let sp=new dhlib.structs.NET_SPEAK_PARAM({\r\n            dwSize:dhlib.structs.NET_SPEAK_PARAM.size,\r\n            nMode:0,\r\n            nSpeakerChannel:0,\r\n            bEnableWait:0\r\n        });\r\n        ok=dhlib.functions.CLIENT_SetDeviceMode(loginID,dhlib.enums.EM_USEDEV_MODE.TALK_SPEAK_PARAM,sp.ref());\r\n        let ttp=new dhlib.structs.NET_TALK_TRANSFER_PARAM({\r\n            dwSize:dhlib.structs.NET_TALK_TRANSFER_PARAM.size,\r\n            bTransfer:0\r\n        });\r\n        expect(!ok).equal(false);\r\n        ok=dhlib.functions.CLIENT_SetDeviceMode(loginID,dhlib.enums.EM_USEDEV_MODE.DH_TALK_TRANSFER_MODE,ttp.ref());\r\n        expect(!ok).equal(false);\r\n    });\r\n\r\n    xit('报警输出',(done)=>{\r\n        let ap = new dhlib.structs.ALARMCTRL_PARAM({\r\n            dwSize: dhlib.structs.ALARMCTRL_PARAM.size,\r\n            nAlarmNo: 0,\r\n            nAction: 1\r\n        });\r\n        //dhlib.enums.CTRL_TYPE.TRIGGER_ALARM_OUT\r\n        let ok=dhlib.functions.CLIENT_ControlDevice(loginID,101,ap.ref(), 1000);\r\n        expect(ok).equal(1);\r\n        setTimeout(done,1000);\r\n    });\r\n\r\n    xit('CLIENT_QueryDevState查询IPC能力',function () {\r\n        let nLenRet=ref.alloc('int');\r\n        let DH_DEV_IPC_INFO=new dhlib.structs.DH_DEV_IPC_INFO();\r\n        //let buffer=DH_DEV_IPC_INFO.ref()//new Buffer(dhlib.structs.DH_DEV_IPC_INFO.size);\r\n        let buffer=ref.alloc(dhlib.structs.DH_DEV_IPC_INFO);\r\n        let bok=dhlib.functions.CLIENT_QueryDevState(\r\n            loginID,\r\n            dhlib.consts.DH_DEVSTATE_IPC,\r\n            DH_DEV_IPC_INFO.ref(),\r\n            dhlib.structs.DH_DEV_IPC_INFO.size,\r\n            nLenRet,\r\n            1000);\r\n        if(!bok){\r\n            console.error(dhlib.functions.CLIENT_GetLastError() & (0x7fffffff));\r\n        }\r\n        expect(bok).equal(1);\r\n        expect(nLenRet.deref()).equal(dhlib.structs.DH_DEV_IPC_INFO.size);\r\n        logoutStruct(dhlib.structs.DH_DEV_IPC_INFO,DH_DEV_IPC_INFO);\r\n /*       nTypeCount:9\r\n        bSupportTypes:0,2,3,6,8,15,22,0,48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0\r\n  大华\r\n  松下\r\n  索尼\r\n  三星\r\n  安讯视AXIS\r\n  Arecont\r\n  Onvif协议\r\n  大华 ??GB2818\r\n  其他自定义\r\n*/\r\n        let ct=DH_DEV_IPC_INFO.toObject().nTypeCount;\r\n        let spt=DH_DEV_IPC_INFO.toObject().bSupportTypes;\r\n        for(let i=0;i<ct;i++){\r\n            console.log(dhlib.enums.IPC_TYPE.get(spt[i]).key);\r\n        }\r\n    });\r\n\r\n    it('zoom-add-stop',async ()=>{\r\n         if(!dhlib.functions.CLIENT_DHPTZControl(loginID,0,dhlib.enums.PTZ.PTZ_ZOOM_ADD,0,3,0,0)||!dhlib.functions.CLIENT_DHPTZControl(loginID,0,dhlib.enums.PTZ.PTZ_ZOOM_ADD,0,3,0,1)){\r\n            console.error(dhlib.functions.CLIENT_GetLastError() & (0x7fffffff));\r\n        }\r\n    });\r\n});"]}