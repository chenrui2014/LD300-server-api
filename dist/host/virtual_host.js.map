{"version":3,"sources":["../../src/host/virtual_host.js"],"names":["_","require","SerialPort","EventEmitter","_options","baudRate","stopBits","dataBits","parity","byteLength","cmds","Buffer","_cmd","normal","alarm","_normalCmd","_alarmCmd","from","VirtualHost","port","_port","_serialPort","on","_onData","bind","_timeHandle","_state","console","log","data","emit","clearTimeout","send","connect","cmdname","postion","logout","write","setTimeout","cmdnew","p","Math","floor","then","toString","Error","disConnect","exports","module"],"mappings":";;;;;;;;;;AAAA,IAAMA,IAAIC,QAAQ,QAAR,CAAV;AACA,IAAMC,aAAaD,QAAQ,0BAAR,CAAnB;AACA,IAAME,eAAeF,QAAQ,QAAR,EAAkBE,YAAvC;;AAEA,IAAMC,WAAS;AACXC,cAAU,MADC;AAEXC,cAAU,CAFC;AAGXC,cAAU,CAHC;AAIXC,YAAQ,MAJG;AAKXC,gBAAY;AALD,CAAf;;AAQA,IAAMC,OAAK;AACP;AACA,IAAIC,MAAJ,CAAW,CAAC,IAAD,EAAO,IAAP,EAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B,EAAoC,IAApC,EAAyC,IAAzC,EAA8C,IAA9C,EAAmD,IAAnD,EAAwD,IAAxD,EAA6D,IAA7D,EAAkE,IAAlE,EAAuE,IAAvE,EAA4E,IAA5E,EAAiF,IAAjF,CAAX,CAFO;AAGP;AACA,IAAIA,MAAJ,CAAW,CAAC,IAAD,EAAO,IAAP,EAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B,EAAoC,IAApC,EAAyC,IAAzC,EAA8C,IAA9C,EAAmD,IAAnD,EAAwD,IAAxD,EAA6D,IAA7D,EAAkE,IAAlE,EAAuE,IAAvE,EAA4E,IAA5E,EAAiF,IAAjF,CAAX,CAJO;AAKP;AACA,IAAIA,MAAJ,CAAW,CAAC,IAAD,EAAO,IAAP,EAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B,EAAoC,IAApC,EAAyC,IAAzC,EAA8C,IAA9C,EAAmD,IAAnD,EAAwD,IAAxD,EAA6D,IAA7D,EAAkE,IAAlE,EAAuE,IAAvE,EAA4E,IAA5E,EAAiF,IAAjF,CAAX,CANO;AAOP;AACA,IAAIA,MAAJ,CAAW,CAAC,IAAD,EAAO,IAAP,EAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B,EAAoC,IAApC,EAAyC,IAAzC,EAA8C,IAA9C,EAAmD,IAAnD,EAAwD,IAAxD,EAA6D,IAA7D,EAAkE,IAAlE,EAAuE,IAAvE,EAA4E,IAA5E,EAAiF,IAAjF,CAAX,CARO,CAAX;;AAWA,IAAMC,OAAK;AACTC,YAAO,QADE,EACOC,OAAM;AADb,CAAX;;AAIA,IAAMC,aAAWL,KAAK,CAAL,CAAjB;AACA,IAAMM,YAAUL,OAAOM,IAAP,CAAY,CAAC,IAAD,EAAO,IAAP,EAAa,IAAb,EAAmB,IAAnB,EAAyB,IAAzB,EAA+B,IAA/B,EAAoC,IAApC,EAAyC,IAAzC,EAA8C,IAA9C,EAAmD,IAAnD,EAAwD,IAAxD,EAA6D,IAA7D,EAAkE,IAAlE,EAAuE,IAAvE,EAA4E,IAA5E,EAAiF,IAAjF,CAAZ,CAAhB;;IAEMC,W;;;AACF,yBAAYC,IAAZ,EAAiB;AAAA;;AAAA;;AAEb,cAAKC,KAAL,GAAWD,IAAX;AACA,cAAKE,WAAL,GAAiB,IAAInB,UAAJ,CAAeiB,IAAf,EAAoBf,QAApB,CAAjB;AACA,cAAKiB,WAAL,CAAiBC,EAAjB,CAAoB,MAApB,EAA2B,MAAKC,OAAL,CAAaC,IAAb,OAA3B;AACA,cAAKC,WAAL,GAAiB,CAAjB;AACA,cAAKC,MAAL,GAAY,OAAZ;AACAC,gBAAQC,GAAR,gDAAyD,MAAKR,KAA9D;AAPa;AAQhB;;;;gCAcOS,I,EAAK;AACT,gBAAGA,KAAK,CAAL,MAAU,IAAb,EAAkB;AACd,qBAAKC,IAAL,CAAU,OAAV,EAAkB,EAACX,MAAK,KAAKC,KAAX,EAAlB;AACAO,wBAAQC,GAAR,gDAAyD,KAAKR,KAA9D;AACA,qBAAKM,MAAL,GAAY,OAAZ;AACAK,6BAAa,KAAKN,WAAlB;AACA,qBAAKO,IAAL,CAAUpB,KAAKC,MAAf;AACA;AACH;AACD,gBAAGgB,KAAK,CAAL,MAAU,CAAb,EAAe;AACX,qBAAKC,IAAL,CAAU,OAAV,EAAkB,EAACX,MAAK,KAAKC,KAAX,EAAlB;AACA,qBAAKM,MAAL,GAAY,OAAZ;AACAC,wBAAQC,GAAR,gDAAyD,KAAKR,KAA9D;AACH;AACJ;;;gCAcM;AACH,mBAAO,KAAKC,WAAL,CAAiBY,OAAjB,EAAP;AACH;;;6BAEIC,O,EAAQC,O,EAAoB;AAAA;;AAAA,gBAAZC,MAAY,uEAAL,IAAK;;AAC7BL,yBAAa,KAAKN,WAAlB;AACA,gBAAGS,YAAUtB,KAAKC,MAAlB,EAAyB;AACrB,qBAAKQ,WAAL,CAAiBgB,KAAjB,CAAuBtB,UAAvB;AACA,qBAAKU,WAAL,GAAiBa,WAAW,KAAKN,IAAL,CAAUR,IAAV,CAAe,IAAf,EAAoBU,OAApB,EAA4BC,OAA5B,CAAX,EAAgD,GAAhD,CAAjB;AACA;AACH;AACD,gBAAGD,YAAUtB,KAAKE,KAAlB,EAAwB;AACpB,oBAAIyB,SAAO5B,OAAOM,IAAP,CAAYD,SAAZ,CAAX;AACA,oBAAIwB,IAAEC,KAAKC,KAAL,CAAWP,UAAQ,CAAnB,CAAN;AACAI,uBAAO,EAAP,IAAWC,IAAE,IAAb;AACAD,uBAAO,EAAP,KAAaC,KAAG,CAAJ,GAAO,GAAnB;AACA,qBAAKnB,WAAL,CAAiBgB,KAAjB,CAAuBE,MAAvB,EAA+BI,IAA/B,CAAoC,YAAI;AACpC,wBAAGP,MAAH,EAAU;AACN,+BAAKV,MAAL,GAAY,OAAZ;AACAC,gCAAQC,GAAR,gDAAyD,OAAKR,KAA9D,yBAAuFmB,OAAOK,QAAP,CAAgB,KAAhB,CAAvF;AACH;AACJ,iBALD;AAMA,qBAAKnB,WAAL,GAAiBa,WAAW,KAAKN,IAAL,CAAUR,IAAV,CAAe,IAAf,EAAoBU,OAApB,EAA4BC,OAA5B,EAAoC,KAApC,CAAX,EAAsD,GAAtD,CAAjB;AACA;AACH;AACD,kBAAM,IAAIU,KAAJ,iBAAwBX,OAAxB,CAAN;AACH;;;+BAEK;AACF,mBAAO,KAAKb,WAAL,CAAiByB,UAAjB,EAAP;AACH;;;iCA1CeX,O,EAAQ;AACpB,gBAAII,SAAO5B,OAAOM,IAAP,CAAYD,SAAZ,CAAX;AACA,gBAAIwB,IAAEC,KAAKC,KAAL,CAAWP,UAAQ,CAAnB,CAAN;AACAI,mBAAO,EAAP,IAAWC,IAAE,IAAb;AACAD,mBAAO,EAAP,KAAaC,KAAG,CAAJ,GAAO,GAAnB;AACA,mBAAOD,MAAP;AACH;;;4BAlCuB;AACpB,mBAAOnC,QAAP;AACH;;;4BAEgB;AACb,mBAAOM,IAAP;AACH;;;4BAEoB;AACjB,mBAAOA,KAAK,CAAL,CAAP;AACH;;;4BA0Be;AACZ,mBAAOE,IAAP;AACH;;;;EAjDqBT,Y;;AAqF1B4C,UAAQC,OAAOD,OAAP,GAAe7B,WAAvB","file":"virtual_host.js","sourcesContent":["const _ = require('lodash');\r\nconst SerialPort = require('../serialport/serialport');\r\nconst EventEmitter = require('events').EventEmitter;\r\n\r\nconst _options={\r\n    baudRate: 115200,\r\n    stopBits: 2,\r\n    dataBits: 8,\r\n    parity: 'none',\r\n    byteLength: 1,\r\n};\r\n\r\nconst cmds=[\r\n    //正常指令\r\n    new Buffer([0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00,0x00,0x33,0x33,0x55,0x15,0x00,0x00,0x00,0x00]),\r\n    //771米异常\r\n    new Buffer([0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00,0x00,0x33,0x33,0x01,0xC1,0x00,0x00,0x00,0x00]),\r\n    //初始化异常\r\n    new Buffer([0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00,0x00,0x33,0x33,0x00,0x40,0x00,0x00,0x00,0x00]),\r\n    //错误指令\r\n    new Buffer([0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00,0x00,0x33,0x30,0x00,0x00,0x00,0x00,0x00,0x00])\r\n];\r\n\r\nconst _cmd={\r\n  normal:'normal',alarm:'alarm'\r\n};\r\n\r\nconst _normalCmd=cmds[0];\r\nconst _alarmCmd=Buffer.from([0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00,0x00,0x33,0x33,0x00,0xC0,0x00,0x00,0x00,0x00]);\r\n\r\nclass VirtualHost extends EventEmitter{\r\n    constructor(port){\r\n        super();\r\n        this._port=port;\r\n        this._serialPort=new SerialPort(port,_options);\r\n        this._serialPort.on('data',this._onData.bind(this));\r\n        this._timeHandle=0;\r\n        this._state='ready';\r\n        console.log(`|||||||||||||||||||||||||||||||||||||host ${this._port} state normal`);\r\n    }\r\n\r\n    static get portOptions(){\r\n        return _options;\r\n    }\r\n\r\n    static get cmds(){\r\n        return cmds;\r\n    }\r\n\r\n    static get nomalCmd(){\r\n        return cmds[0];\r\n    }\r\n\r\n    _onData(data){\r\n        if(data[0]===0xAA){\r\n            this.emit('reset',{port:this._port});\r\n            console.log(`|||||||||||||||||||||||||||||||||||||host ${this._port}  state reseted`);\r\n            this._state='reset';\r\n            clearTimeout(this._timeHandle);\r\n            this.send(_cmd.normal);\r\n            return;\r\n        }\r\n        if(data[0]===0){\r\n            this.emit('ready',{port:this._port});\r\n            this._state='ready';\r\n            console.log(`|||||||||||||||||||||||||||||||||||||host ${this._port} state sys rdy`);\r\n        }\r\n    }\r\n\r\n    static AlarmCmd(postion){\r\n        let cmdnew=Buffer.from(_alarmCmd);\r\n        let p=Math.floor(postion/3);\r\n        cmdnew[10]=p&0xFF;\r\n        cmdnew[11]+=(p>>8)&0xF;\r\n        return cmdnew;\r\n    }\r\n\r\n    static get CMD(){\r\n        return _cmd;\r\n    }\r\n\r\n    start(){\r\n        return this._serialPort.connect();\r\n    }\r\n\r\n    send(cmdname,postion,logout=true){\r\n        clearTimeout(this._timeHandle);\r\n        if(cmdname===_cmd.normal){\r\n            this._serialPort.write(_normalCmd);\r\n            this._timeHandle=setTimeout(this.send.bind(this,cmdname,postion),250);\r\n            return;\r\n        }\r\n        if(cmdname===_cmd.alarm){\r\n            let cmdnew=Buffer.from(_alarmCmd);\r\n            let p=Math.floor(postion/3);\r\n            cmdnew[10]=p&0xFF;\r\n            cmdnew[11]+=(p>>8)&0xF;\r\n            this._serialPort.write(cmdnew).then(()=>{\r\n                if(logout){\r\n                    this._state='alarm';\r\n                    console.log(`|||||||||||||||||||||||||||||||||||||host ${this._port} state alarm,cmd ${cmdnew.toString('hex')}`);\r\n                }\r\n            });\r\n            this._timeHandle=setTimeout(this.send.bind(this,cmdname,postion,false),250);\r\n            return;\r\n        }\r\n        throw new Error(`unknow cmd ${cmdname}`);\r\n    }\r\n\r\n    stop(){\r\n        return this._serialPort.disConnect();\r\n    }\r\n}\r\n\r\n\r\nexports=module.exports=VirtualHost;"]}