{"version":3,"sources":["../../src/log/log.js"],"names":["_","require","path","config","global","server_config","log4js","mkdirp","logs_dirs","getLogDir","logDir","resolve","errorDir","warnDir","process","productionsEnv","env","NODE_ENV","sync","configure","appenders","type","category","level","absolute","filename","maxLogSize","encoding","alwaysIncludePattern","pattern","consoleLogger","getLogger","logger","errorLogger","log","fileLogger","source","_params","desc","params","extend","time","Date","toLocaleString","logStr","JSON","stringify","info","error","warn","Parser","classOrObject","name","split","p","addAppender","appenderMakers","bind","exports","module"],"mappings":"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","file":"log.js","sourcesContent":["const _=require('lodash');\r\nconst path=require('path');\r\nconst config=global.server_config||require('../config/config');\r\nconst log4js = require('log4js');\r\nconst mkdirp=require('mkdirp');\r\nconst logs_dirs=config.getLogDir();\r\nconst logDir=path.resolve(logs_dirs,'log');\r\nconst errorDir=path.resolve(logs_dirs,'error');\r\nconst warnDir=path.resolve(logs_dirs,'error');\r\nconst process=require('process');\r\nconst productionsEnv = (process.env.NODE_ENV || 'production')==='production';\r\nmkdirp.sync(logDir);\r\nmkdirp.sync(errorDir);\r\nmkdirp.sync(warnDir);\r\n\r\nlog4js.configure({\r\n    appenders: [\r\n        {\r\n            type:\"console\",\r\n            category:\"console\",\r\n            level:'info'\r\n        },{\r\n            category:'info',\r\n            type: 'dateFile',\r\n            absolute:true,\r\n            filename: path.resolve(config.getLogDir(),'log/log'),\r\n            maxLogSize : 102400,//单位字节,现在配置100KB\r\n            encoding : 'utf-8',\r\n            alwaysIncludePattern: true,\r\n            pattern: \"-yyyy-MM-dd-hh.log\",\r\n            level:'info'\r\n        }, {\r\n            category:'error',\r\n            type: 'dateFile',\r\n            absolute:true,\r\n            filename: path.resolve(config.getLogDir(),'error/error'),\r\n            maxLogSize : 102400,//单位字节,现在配置100KB\r\n            encoding : 'utf-8',\r\n            alwaysIncludePattern: true,\r\n            pattern: \"-yyyy-MM-dd-hh.log\",\r\n            level:'info'\r\n        }]\r\n});\r\n\r\nconst consoleLogger=log4js.getLogger('console');\r\nconst logger = log4js.getLogger('info');\r\nconst errorLogger = log4js.getLogger('error');\r\n\r\nfunction log(fileLogger,source,_params,desc,params){\r\n    let log=_.extend({\r\n        desc:desc,\r\n        time:new Date().toLocaleString()\r\n    },_params,params,{source:source});\r\n    let logStr=JSON.stringify(log);\r\n    logger.info(logStr);\r\n    !productionsEnv&&consoleLogger.info(logStr);\r\n    fileLogger.info(logStr);\r\n    return log;\r\n}\r\n\r\nfunction error(fileLogger,source,_params,desc,params){\r\n    let log=_.extend({\r\n        desc:desc\r\n    },_params,params,{source:source});\r\n    let logStr=JSON.stringify(log);\r\n    logger.error(logStr);\r\n    errorLogger.error(logStr);\r\n    !productionsEnv&&consoleLogger.error(logStr);\r\n    fileLogger.error(logStr);\r\n    return log;\r\n}\r\n\r\nfunction warn(fileLogger,source,_params,desc,params){\r\n    let log=_.extend({\r\n        desc:desc\r\n    },_params,params,{source:source});\r\n    let logStr=JSON.stringify(log);\r\n    logger.warn(logStr);\r\n    errorLogger.warn(logStr);\r\n    !productionsEnv&&consoleLogger.warn(logStr);\r\n    fileLogger.warn(logStr);\r\n    return log;\r\n}\r\n\r\nfunction Parser(classOrObject,source,params){\r\n    let name=source.split('.')[0];\r\n    let p=path.resolve(config.getLogDir(),`log/${name}`);\r\n    mkdirp.sync(p);\r\n    log4js.addAppender(log4js.appenderMakers['dateFile']({\r\n        category:name,\r\n        type: 'dateFile',\r\n        absolute:true,\r\n        filename: `${p}/${name}`,\r\n        maxLogSize : 102400,//单位字节,现在配置100KB\r\n        encoding : 'utf-8',\r\n        alwaysIncludePattern: true,\r\n        pattern: \"-yyyy-MM-dd-hh.log\",\r\n        level:'info'\r\n    }),name);\r\n    const fileLogger=log4js.getLogger(name);\r\n    classOrObject.info=classOrObject.log=log.bind(null,fileLogger,source,params);\r\n    classOrObject.error=error.bind(null,fileLogger,source,params);\r\n    classOrObject.warn=warn.bind(null,fileLogger,source,params);\r\n}\r\n\r\nexports=module.exports={\r\n    Parser:Parser\r\n};"]}