{"version":3,"sources":["../../../src/ipcs/base/ipc.js"],"names":["PTZ","require","_","config","global","server_config","ptzLock","get","url","assert","Counter","_q","_events","IPC","options","each","val","key","smooth","on","_newListener","bind","_removeListener","_realpaly_counter","_talk_counter","event","listenerCount","Alive","_listen","Offline","_stopListen","ok","inReference","addReference","log","count","isPlaying","_realPlay","release","_stopRealPlay","Error","inTalking","_startTalk","_stopTalk","data","size","pt","id","Directions","exports","module"],"mappings":"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","file":"ipc.js","sourcesContent":["/**\r\n * Created by Luky on 2017/7/1.\r\n */\r\n\r\nconst PTZ=require('./ptz');\r\nconst _=require('lodash');\r\nconst config=global.server_config||require('../../config/config');\r\nconst ptzLock=_.get(config,'ipc.ptzLock',15000);\r\nconst url=require('url');\r\nconst assert=require('assert');\r\nconst Counter=require('./counter');\r\n\r\nconst _q={\r\n    'smooth':0,\r\n    'clear':1,\r\n    'hd':2\r\n};\r\n\r\n/*const _s={\r\n    'idel':0,\r\n    'call':1\r\n};*/\r\n/*\r\nconst _runWay={\r\n    'pull':0,\r\n    'push':1,\r\n    'cache':2\r\n};*/\r\n\r\nconst _events={\r\n    'Connected':'connected',\r\n    'DisConnected':'disConnected',\r\n    'RealPlay':'realPlay',\r\n    'StopRealPlay':'stopRealPlay',\r\n    'AudioPlay':'audioPlay',\r\n    'AudioStopPlay':'audioStopPlay',\r\n    'Alarm':'alarm',\r\n    'AlarmStop':'alarmStop',\r\n    'Online':'online',\r\n    'Offline':'offline',\r\n    'Error':'error'\r\n};\r\n\r\nclass IPC extends PTZ{\r\n    constructor(options){\r\n        super(/*{ objectMode: true }*/options);\r\n        _.each({'id':0,'brand':''},(val,key)=>{this.options[key]=key in options?options[key]:val;});\r\n        _.each({\r\n           'quality':_q.smooth\r\n        },(val,key)=>{this[key]=key in options?options[key]:val;});\r\n/*        this._state=_s.idel;*/\r\n        this.on('newListener', this._newListener.bind(this));\r\n        this.on('removeListener', this._removeListener.bind(this));\r\n        /*this._runWay=config.runWay;\r\n         if(config.runWay!==_runWay.pull){\r\n         }*/\r\n        this._realpaly_counter=new Counter();\r\n        this._talk_counter=new Counter();\r\n    }\r\n\r\n    get id(){\r\n        return this.options.id;\r\n    }\r\n\r\n    static get Events(){\r\n        return _events;\r\n    }\r\n\r\n    _newListener(event) {\r\n        if(this.listenerCount(event)!== 0) return;\r\n        if (event === _events.Alive) {\r\n            this._listen();\r\n        }\r\n    }\r\n\r\n    _removeListener(event) {\r\n        if(this.listenerCount(event)!== 0) return;\r\n        if (event ===_events.Offline) {\r\n            this._stopListen();\r\n        }\r\n    }\r\n\r\n    static get Directions(){\r\n        return PTZ.Directions;\r\n    }\r\n    static get quality(){\r\n        return _q;\r\n    }\r\n    get supportPTZ(){return false;}\r\n    get supportAudio(){return false;}\r\n    get supportAlarm(){return false;}\r\n    setPlaying(){\r\n        assert.ok(!this._realpaly_counter.inReference);\r\n        this._realpaly_counter.addReference();\r\n        this.log('更新视频播放请求数',{count:this._realpaly_counter.count});\r\n    }\r\n    get isPlaying(){return this._realpaly_counter.inReference;}\r\n    async realPlay() {\r\n        if(this.isPlaying) {\r\n            this._realpaly_counter.addReference();\r\n            this.log('更新视频播放请求数',{count:this._realpaly_counter.count});\r\n            return;\r\n        }\r\n        await this._realPlay();\r\n    }\r\n    async stopRealPlay() {\r\n        if(this._realpaly_counter.release()){\r\n            await this._stopRealPlay();\r\n        }\r\n        this.log('更新视频播放请求数',{count:this._realpaly_counter.count});\r\n    }\r\n    //全部从辅码1流中获取，如果需要高精度请对应设置设备参数\r\n    async _realPlay() {throw new Error('未实现函数_realPlay');}\r\n    async _stopRealPlay() {throw new Error('未实现函数_stopRealPlay');}\r\n    //要求promise自己catch掉，视频可用的情况下要启用视频\r\n    //这两个端口暂时不使用,用于打开独立的音频输入输出\r\n    setTalking(){\r\n        assert.ok(!this._talk_counter.inReference);\r\n        this._talk_counter.addReference();\r\n    }\r\n    get inTalking(){return this._talk_counter.inReference;}\r\n    async startTalk(){\r\n        if(this.inTalking) {\r\n            this._talk_counter.addReference();\r\n            return;\r\n        }\r\n        await this._startTalk();\r\n    }\r\n    async stopTalk(){\r\n        if(this._talk_counter.release()){\r\n            await this._stopTalk();\r\n        }\r\n    }\r\n    async _startTalk(){throw new Error('未实现函数_startTalk');}\r\n    async _stopTalk(){throw new Error('未实现函数_stopTalk');}\r\n    async setTalkData(data,size){throw new Error('未实现函数setTalkData');}\r\n    async setVolume(pt){throw new Error('未实现函数setVolume');}\r\n    _listen(){throw new Error('未实现函数listen');}\r\n    _stopListen(){throw new Error('未实现函数stopListen');}\r\n    async alarm(){throw new Error('未实现函数alarm');}\r\n    async stopAlarm(){throw new Error('未实现函数stopAlarm');}\r\n}\r\nexports=module.exports=IPC;"]}