{"version":3,"sources":["../../../src/ipcs/dahua/dh_ipc.js"],"names":["IPC","require","Onvif","_","dhok","dhlib","globalConfig","global","server_config","config","getConfig","ref","assert","ArrayType","fs","acc","DHAV","Buffer","from","dhav","h264Prefix","aacPrefix","Parser","EventEmitter","DHIPC","options","each","val","key","get","_loginID","_playID","_talkID","_channel","_stopCmd","onvif","extend","_disConnectFn","_onDisConnected","bind","_reConnectFn","_onReConnected","_vedioBuffer","id","ip","port","getRtspUriWithAuth","Promise","reject","desc","code","lastError","err","error","ok","st","structs","DH_DEV_ENABLE_INFO","nLenRet","alloc","asyncFunctions","CLIENT_QuerySystemInfo","enums","DH_SYS_ABILITY","DEVALL_INFO","size","ab","toObject","fn_ptz","IsFucEnable","DH_DEV_ENABLE","HIDE_FUNCTION","json","JSON_CONFIG","loginType","TCP","NET_DEVICEINFO_Ex","CLIENT_LoginEx2","user","pwd","NULL","_error","_getAbility","b3g_protocol","nChanNum","setConnected","emit","Events","Connected","log","resolve","all","stopRealPlay","stopTalk","catch","e","logID","CLIENT_Logout","DisConnected","buf","cb","concat","startWithDHAV","slice","indexOf","endWithdhav","index","indexPre","connect","CLIENT_RealPlayEx","playType","Realplay_1","Error","_playcb","callbacks","fRealDataCallBackEx","rid","dataType","data","utils","readBuffer","_pushData","prototype","call","CLIENT_SetRealDataCallBackEx","setPlaying","RealPlay","playID","CLIENT_StopRealPlayEx","StopRealPlay","disConnect","_talkInit","_talkcb","pfAudioDataCallBack","isPlaying","tid","CLIENT_StartTalkEx","AudioPlay","setTalking","_audio_config","lst","TALKFORMAT_LIST","CLIENT_QueryDevState","consts","DEVSTATE_TALK_ECTYPE","i","nSupportNum","lsti","type","encodeType","TALK_CODING_TYPE","AAC","value","dwSampleRate","nAudioBit","_getAudioEncodeType","CLIENT_SetDeviceMode","EM_USEDEV_MODE","TALK_SERVER_MODE","en","TALKDECODE_INFO","nPacketPeriod","TALK_ENCODE_TYPE","sp","NET_SPEAK_PARAM","dwSize","nMode","nSpeakerChannel","bEnableWait","TALK_SPEAK_PARAM","ttp","NET_TALK_TRANSFER_PARAM","bTransfer","TALK_TRANSFER_MODE","CLIENT_StopTalkEx","AudioStopPlay","CLIENT_TalkSendData","loginID","clearInterval","_onlineInterval","_offileInterval","setInterval","Offline","warn","loginid","Online","then","on","innerError","removeListener","cmdCode","p1","p2","p3","param4","stop","supportPTZ","cmd","CLIENT_DHPTZControlEx2","valueOf","toString","setTimeout","_PTZ","PTZ","PTZ_ZOOM_ADD","zoom_speed","PTZ_ZOOM_DEC","PTZ_FOCUS_ADD","focus_speed","PTZ_FOCUS_DEC","PTZ_APERTURE_ADD","aperture_speed","PTZ_APERTURE_DEC","direction","_d","Directions","top","left","right","down","lefttop","leftdown","righttop","rightdown","PTZ_UP","PTZ_LEFT","PTZ_RIGHT","PTZ_DOWN","EXTPTZ_LEFTTOP","EXTPTZ_RIGHTDOWN","EXTPTZ_RIGHTTOP","v_speed","h_speed","x","y","z","pos","PTZ_CONTROL_ABSOLUTELY","stuPosition","PTZ_SPACE_UNIT","nPositionX","nPositionY","nZoom","stuSpeed","PTZ_SPEED_UNIT","fPositionX","fPositionY","fZoom","EXTPTZ_MOVE_ABSOLUTELY","pt","preset","PTZ_POINT_MOVE","moveToPoint","location","DH_PTZ_LOCATION_INFO","DH_DEVSTATE_PTZ_LOCATION","bok","deref","nPTZPan","nPTZTilt","nPTZZoom","open","supportAlarm","ALARMCTRL_PARAM","ap","nAlarmNo","nAction","CLIENT_ControlDevice","Alarm","AlarmStop","fn_alarm","_alarm","CLIENT_SetVolume","ptz","audio","alarm","timeout","callback","fSearchDevicesCB","DEVICE_NET_INFO_EX","dataClone","ipcData","ipcInfo","structParser","szDetailType","iIPVersion","szIP","nPort","CLIENT_StartSearchDevices","handle","CLIENT_StopSearchDevices","functions","CLIENT_GetLastError","exports","module"],"mappings":"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","file":"dh_ipc.js","sourcesContent":["/**\r\n * Created by Luky on 2017/7/1.\r\n */\r\nconst IPC=require('../base/ipc');\r\nconst Onvif=require('../onvif/onvif_ipc');\r\nconst _=require('lodash');\r\nconst dhok=require('./dh_init');\r\nconst dhlib=require('./dhnetsdk');\r\nconst globalConfig=global.server_config||require('../../config/config');\r\nconst config=globalConfig.getConfig('dh_config.json');\r\nconst ref=require('ref');\r\n//const isLinux=process.platform.indexOf('win')===-1;\r\nconst assert=require('assert');\r\nconst ArrayType=require('ref-array');\r\n//const Mix=require('../stream/stream_ffmpeg_pipe');\r\n//const timeSpan=require('../../TimeSpan');\r\n//const DHH264UnPack=require('./_dh_h264_unpack');\r\n//const wchar_t = require('ref-wchar');\r\nconst fs = require('fs');\r\nconst acc=require('../../acc/acc_adts_parser');\r\nconst DHAV=Buffer.from([0x44,0x48,0x41,0x56]);\r\nconst dhav=Buffer.from([0x64,0x68,0x61,0x76]);\r\nconst h264Prefix=Buffer.from([0,0,0,1]);\r\nconst aacPrefix=Buffer.from([0xff]);\r\nconst {Parser} =require('../../log/log');\r\nconst EventEmitter =require('events').EventEmitter;\r\n\r\nclass DHIPC extends IPC{\r\n    constructor(options){\r\n        super(options);\r\n        _.each({\r\n            \"zoom_speed\":config['zoomSpeed'],\"focus_speed\":config['focusSpeed'],\r\n            \"aperture_speed\":config['apertureSpeed'],\"h_speed\":config['hSpeed'],\r\n            \"v_speed\":config['vSpeed']\r\n        },(val,key)=>{this[key]=key in options?options[key]:val;});\r\n        _.each({\"ptz\":false,\"audio\":false,\"alarm\":false},(val,key)=>{\r\n            this.options[key]=!!_.get(options,`functions.${key}`,val);\r\n        });\r\n        _.each({'ip':'','port':0,'user':'','pwd':'',\r\n            'b3g_protocol':false\r\n        },(val,key)=>{this.options[key]=key in options?options[key]:val;});\r\n        this._loginID=0;\r\n        this._playID=0;\r\n        this._talkID=0;\r\n        this._channel=0;\r\n        this._stopCmd=null;\r\n        this.onvif=null;\r\n        if(options.onvif)this.onvif=new Onvif(_.extend({},options,options.onvif));\r\n        this._disConnectFn=this._onDisConnected.bind(this);\r\n        this._reConnectFn=this._onReConnected.bind(this);\r\n        this._vedioBuffer=null;\r\n        Parser(this,'dh_ipc.js',{id:this.options.id,ip:this.options.ip,port:this.options.port});\r\n        //this._keepAlive=0;\r\n    }\r\n\r\n    getRtspUriWithAuth() {\r\n        if(this.onvif) return this.onvif.getRtspUriWithAuth();\r\n        return Promise.reject();\r\n    }\r\n\r\n    get supportPTZ(){return this.options.ptz;}\r\n    get supportAudio(){return this.options.audio;}\r\n    get supportAlarm(){return this.options.alarm;}\r\n\r\n    _error(desc){\r\n        let code=desc?DHIPC.lastError:0;\r\n        let err={code:code};\r\n        return this.error(desc||'具体错误请参照DhNetSdk.Client_GetLastError',err);\r\n    }\r\n\r\n    static get lastError(){\r\n        return dhlib.functions.CLIENT_GetLastError()&(0x7fffffff);\r\n    }\r\n\r\n    async _getAbility(){\r\n        assert.ok(this._loginID);\r\n        let st=dhlib.structs.DH_DEV_ENABLE_INFO;\r\n        let DH_DEV_ENABLE_INFO=new st();\r\n        let nLenRet=ref.alloc('int');\r\n        let ok=await dhlib.asyncFunctions.CLIENT_QuerySystemInfo(this._loginID,dhlib.enums.DH_SYS_ABILITY.DEVALL_INFO,DH_DEV_ENABLE_INFO.ref(),st.size,nLenRet,1000);\r\n        if(!ok){\r\n            return null;\r\n            //console.error(dhlib.functions.CLIENT_GetLastError() & (0x7fffffff));\r\n        }\r\n        let ab=DH_DEV_ENABLE_INFO.toObject();\r\n        return{\r\n            fn_ptz:ab.IsFucEnable[dhlib.enums.DH_DEV_ENABLE.HIDE_FUNCTION]===0,\r\n            json:ab.IsFucEnable[dhlib.enums.DH_DEV_ENABLE.JSON_CONFIG]!==0,\r\n        };\r\n    }\r\n\r\n    async  _connect() {\r\n        if(!dhok) {\r\n            let error=this.error('大华SDK初始化异常');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n            //let x=timeSpan.start('打开连接');\r\n        const loginType=dhlib.enums.loginType.TCP;\r\n        let NET_DEVICEINFO_Ex=new dhlib.structs.NET_DEVICEINFO_Ex();\r\n        let err=ref.alloc('int');\r\n        this._loginID=await dhlib.asyncFunctions.CLIENT_LoginEx2(this.options.ip,this.options.port,this.options.user,this.options.pwd,loginType,ref.NULL,NET_DEVICEINFO_Ex.ref(),err)\r\n        //err=err.deref();\r\n        if(!this._loginID){\r\n            let error=this._error('设备登入错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        if(false){\r\n            let ab=await this._getAbility();\r\n            this.options.fn_ptz=ab.fn_ptz||false;\r\n            this.options.b3g_protocol=ab.json||NET_DEVICEINFO_Ex.toObject().nChanNum>32||false;\r\n        }\r\n        this.setConnected();\r\n        this.emit(IPC.Events.Connected,this.log('设备已连接'));\r\n    }\r\n    async _disConnect() {\r\n        if(!this._loginID)return await Promise.resolve();\r\n        await Promise.all([this.stopRealPlay(),this.stopTalk()]).catch(e=>e);\r\n        let logID=this._loginID;this._loginID=0;\r\n        if(await dhlib.asyncFunctions.CLIENT_Logout(logID)){\r\n            this.emit(IPC.Events.DisConnected,this.log('设备已断开连接'));\r\n            return;\r\n        }\r\n        return Promise.reject(this._error('大华设备登出错误'));\r\n    }\r\n\r\n/*    _transform(buf,enc,next){\r\n        next(null,buf);\r\n    }*/\r\n\r\n    get inPlay(){return !!this._playID;}\r\n\r\n    _pushData(buf,cb){\r\n        //console.log(buf.toString('hex'));\r\n\r\n        if(this._vedioBuffer){\r\n            buf=Buffer.concat([this._vedioBuffer,buf]);\r\n        }\r\n\r\n        const startWithDHAV=buf.slice(0,4).indexOf(DHAV)===0,\r\n            endWithdhav=buf.slice(-8).indexOf(dhav)===0;\r\n\r\n        let slice=function (buf) {\r\n            if(buf.slice(0,4).indexOf(h264Prefix)===0){\r\n                let index,indexPre=0;\r\n                while((index=buf.indexOf(h264Prefix,indexPre+4))!==-1){\r\n                    cb(buf.slice(indexPre,index));\r\n                    buf=buf.slice(index);\r\n                }\r\n                cb(buf);\r\n            }\r\n            else if(buf[0]===aacPrefix[0]&&(buf[1]&0xf0)===0xf0){\r\n                cb(buf);\r\n            }\r\n        };\r\n        if(startWithDHAV&&endWithdhav){\r\n            if(buf[5]===0xf1) {\r\n                return;\r\n            }\r\n            buf=buf.slice(40,-8);\r\n            slice(buf);\r\n            if(this._vedioBuffer){\r\n                this._vedioBuffer=null;\r\n            }\r\n        }\r\n        else{\r\n            this._vedioBuffer=Buffer.from(buf);\r\n        }\r\n\r\n    }\r\n\r\n    //有音频设置时同样会返回音频数据\r\n    async _realPlay() {\r\n        await this.connect();\r\n        this._playID=await dhlib.asyncFunctions.CLIENT_RealPlayEx(this._loginID,this._channel,ref.NULL,dhlib.enums.playType.Realplay_1);\r\n        if(!this._playID){\r\n            let error=this._error('获取设备的播放句柄错误');\r\n            this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        //let id=this.options.id;\r\n        let cb=this._playcb=dhlib.callbacks.fRealDataCallBackEx((rid,dataType,data,size/*,param,dwuser*/)=>{\r\n            let buf=dhlib.utils.readBuffer(data,size);\r\n            //console.log(buf.slice(4,5).toString('hex')+'\\r');\r\n            //if(buf[4]===0xfd) console.log(buf.toString('utf8')+'\\r');\r\n            this._pushData(buf,(data)=>{\r\n                EventEmitter.prototype.emit.call(this,'video',data);\r\n            });\r\n        });\r\n        if(!await dhlib.asyncFunctions.CLIENT_SetRealDataCallBackEx(this._playID,cb,0,1)){\r\n            delete this._playcb;\r\n            let error=this._error('直播数据回调函数绑定异常');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        this.setPlaying();\r\n        this.emit(IPC.Events.RealPlay,this.log('直播端口已打开'));\r\n    }\r\n\r\n    async _stopRealPlay() {\r\n        if(!this._playID) return;\r\n        let playID=this._playID;this._playID=0;\r\n        if(await dhlib.asyncFunctions.CLIENT_StopRealPlayEx(playID)){\r\n            this.emit(IPC.Events.StopRealPlay,this.log('直播端口关闭'));\r\n        }\r\n        else{\r\n            this._error('直播端口关闭异常')\r\n            //this.emit(IPC.Events.Error,this._error('直播端口关闭异常'));\r\n        }\r\n        delete this._playcb;\r\n        await this.disConnect();\r\n    }\r\n\r\n    async _startTalk(){\r\n        await this.connect();\r\n        /*let type =*/await this._talkInit();\r\n        //如果在播放中就不通过talk拉取音频了，视频中已经取回了音频，这里再取会出问题\r\n        let cb=this._talkcb=dhlib.callbacks.pfAudioDataCallBack(this.isPlaying?()=>{}:(tid,data,size/*,remotedwuser*/)=>{\r\n            let buf=dhlib.utils.readBuffer(data,size);\r\n            this._pushData(buf,(data)=>{\r\n                EventEmitter.prototype.emit.call(this,'audio',data);\r\n            });\r\n        });\r\n        this._talkID=await dhlib.asyncFunctions.CLIENT_StartTalkEx(this._loginID,cb,0);\r\n        if(!this._talkID) {\r\n            delete this._talkcb;\r\n            //_this.options.fn_audio=false;\r\n            return await Promise.reject(this._error('startTalk'));\r\n        }\r\n/*      if(!isLinux){\r\n            if(!dhlib.functions.CLIENT_RecordStartEx(_this._talkID)){\r\n                return reject(this._error('recordStartEx'));\r\n\r\n            }\r\n        }*/\r\n        this.emit(IPC.Events.AudioPlay,this.log('音频对讲端口打开'));\r\n        this.setTalking();\r\n    }\r\n\r\n    async _getAudioEncodeType(){\r\n        if(this._audio_config) return this._audio_config;\r\n        if(!this._loginID) return await Promise.reject('请先连接设备');\r\n        let lst=new dhlib.structs.TALKFORMAT_LIST();\r\n        let nLenRet=ref.alloc('int');\r\n        let ok=await dhlib.asyncFunctions.CLIENT_QueryDevState(this._loginID,dhlib.consts.DEVSTATE_TALK_ECTYPE,lst.ref(),dhlib.structs.TALKFORMAT_LIST.size,nLenRet,1000);\r\n        if(!ok/*nLenRet.deref()!==dhlib.structs.TALKFORMAT_LIST.size*/){\r\n            let error=this._error('无法查找到设备支持的音频编码格式');\r\n            this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        for(let i=0;i<lst.nSupportNum;i++){\r\n            let lsti=lst.type[i];\r\n            if(lsti.encodeType===dhlib.enums.TALK_CODING_TYPE.AAC.value/*||lsti.encodeType===dhlib.enums.TALK_CODING_TYPE.mp3*/){\r\n                return this._audio_config={\r\n                    dwSampleRate:lsti.dwSampleRate,\r\n                    encodeType:lsti.encodeType,\r\n                    nAudioBit:lsti.nAudioBit\r\n                };\r\n            }\r\n        }\r\n        let error=this._error('设备不支持AAC音频编码');\r\n        //this.emit(IPC.Events.Error,error);\r\n        return await Promise.reject(error);\r\n    }\r\n\r\n    async _talkInit()\r\n    {\r\n        let type=await this._getAudioEncodeType();\r\n        let ok=await dhlib.asyncFunctions.CLIENT_SetDeviceMode(this._loginID,dhlib.enums.EM_USEDEV_MODE.TALK_SERVER_MODE,ref.NULL);\r\n        if(!ok){\r\n            let error=this._error('设置音频为服务端模式错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        let en=dhlib.structs.TALKDECODE_INFO({\r\n            encodeType:type.encodeType,\r\n            nAudioBit:type.nAudioBit,\r\n            dwSampleRate:type.dwSampleRate,\r\n            nPacketPeriod:25\r\n        });\r\n\r\n        ok=await dhlib.asyncFunctions.CLIENT_SetDeviceMode(this._loginID,dhlib.enums.EM_USEDEV_MODE.TALK_ENCODE_TYPE,en.ref());\r\n        if(!ok){\r\n            let error=this._error('设置音频格式错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        let sp=new dhlib.structs.NET_SPEAK_PARAM({\r\n            dwSize:dhlib.structs.NET_SPEAK_PARAM.size,\r\n            nMode:0,\r\n            nSpeakerChannel:0,\r\n            bEnableWait:0\r\n        });\r\n        ok=await dhlib.asyncFunctions.CLIENT_SetDeviceMode(this._loginID,dhlib.enums.EM_USEDEV_MODE.TALK_SPEAK_PARAM,sp.ref());\r\n        if(!ok){\r\n            let error=this._error('设置音频模式错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        let ttp=new dhlib.structs.NET_TALK_TRANSFER_PARAM({\r\n            dwSize:dhlib.structs.NET_TALK_TRANSFER_PARAM.size,\r\n            bTransfer:0\r\n        });\r\n        ok=await dhlib.asyncFunctions.CLIENT_SetDeviceMode(this._loginID,dhlib.enums.EM_USEDEV_MODE.TALK_TRANSFER_MODE,ttp.ref());\r\n        if(!ok){\r\n            let error=this._error('设置音频传输方式错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        return type;\r\n    }\r\n\r\n    async _stopTalk(){\r\n        if(this._talkcb) delete this._talkcb;\r\n        if(!this._talkID) return;\r\n        if(1===await dhlib.asyncFunctions.CLIENT_StopTalkEx(this._talkID)){\r\n            this.emit(IPC.Events.AudioStopPlay,this.log('音频对讲端口关闭'));\r\n        }\r\n        else{\r\n            /*let error=*/this._error('停止对讲发生错误')\r\n            //this.emit(IPC.Events.Error,error);\r\n        }\r\n        await this.disConnect();\r\n    }\r\n\r\n    async setTalkData(data,size){\r\n        if(!this._talkID) return await Promise.reject(this._error('需要先打开通道',false));\r\n        if(size===await dhlib.asyncFunctions.CLIENT_TalkSendData(this._talkID,data,size)){\r\n            return;\r\n        }\r\n        let error=this._error('向音频数据发送异常');\r\n        //this.emit(IPC.Events.Error,error);\r\n        return await Promise.reject(error);\r\n    }\r\n\r\n    _onDisConnected(loginID/*,string,port,dwuser*/){\r\n        if(this._loginID!==loginID){\r\n            return;\r\n        }\r\n        clearInterval(this._onlineInterval||0);\r\n        this._offileInterval=setInterval(()=>{\r\n            this.emit(IPC.Events.Offline,this.warn('连接被动断开超过6秒，请查看设备或网络情况'));\r\n        },6000);\r\n    }\r\n\r\n    _onReConnected(loginid/*,string,port,dwuser*/){\r\n        if(this._loginID!==loginid){\r\n            return;\r\n        }\r\n        clearInterval(this._offileInterval||0);\r\n        this._offileInterval=0;\r\n        this.emit(IPC.Events.Online);\r\n    }\r\n\r\n    _listen(){\r\n        this.connect().then(()=>{\r\n            dhlib.on('disconnect',this._disConnectFn);\r\n            dhlib.on('reconnected',this._reConnectFn);\r\n            this.emit(IPC.Events.Online);\r\n        }).catch((e)=>{\r\n            this.emit(IPC.Events.Offline,{innerError:e});\r\n        });\r\n    }\r\n\r\n    _stopListen(){\r\n        //this._keepAlive&=0xd;\r\n        dhlib.removeListener('disconnect',this._disConnectFn);\r\n        dhlib.removeListener('reconnected',this._reConnectFn);\r\n    }\r\n\r\n    async _PTZ(cmdCode,p1,p2,p3=0,param4=null,stop=false){\r\n        if(!this.supportPTZ) return await Promise.reject(this._error('_PTZ','设备不支持PTZ操作'));\r\n        await this.connect();\r\n        let cmd=_.bind(dhlib.asyncFunctions.CLIENT_DHPTZControlEx2,null,_,_,cmdCode.valueOf(),p1,p2,p3,_,(param4?param4.ref():ref.NULL));\r\n        if(await cmd(this._loginID,this._channel,false)){\r\n            this.log(`成功执行PTZ操作,操作：${cmdCode.toString()}`);\r\n            if(!stop) this._stopCmd = cmd;\r\n            else {\r\n                this._stopCmd=null;\r\n                return new Promise((resolve,reject)=>{\r\n                    setTimeout(()=>{\r\n                        cmd(this._loginID,this._channel,true);\r\n                        this.disConnect().then(resolve).catch(reject);\r\n                    },10);\r\n                });\r\n            }\r\n            //return;\r\n        }\r\n        else{\r\n            /*let error=*/this._error('ptz操作错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n            //return await Promise.reject(error);\r\n\r\n        }\r\n        await this.disConnect();\r\n\r\n    }\r\n\r\n\r\n    async ptzStop(){\r\n        if(this._stopCmd===null){\r\n            return;\r\n        }\r\n        let cmd=this._stopCmd;\r\n        this._stopCmd=null;\r\n        await this.connect();\r\n        let ok=cmd(this._loginID,this._channel,false)&&cmd(this._loginID,this._channel,true);\r\n        await this.disConnect();\r\n        if(ok){\r\n            return this.log('成功执行PTZ停止操作');\r\n        }\r\n        let error=this._error('停止ptz操作错误');\r\n        //this.emit(IPC.Events.Error,error);\r\n        return await Promise.reject(error);\r\n    }\r\n\r\n    async zoomAdd(stop) {\r\n        return await this._PTZ(dhlib.enums.PTZ.PTZ_ZOOM_ADD,0,this.zoom_speed,0,null,stop);\r\n    }\r\n\r\n    async zoomDec(stop) {\r\n        return await this._PTZ(dhlib.enums.PTZ.PTZ_ZOOM_DEC,0,this.zoom_speed,0,null,stop);\r\n    }\r\n\r\n    async focusAdd(stop) {\r\n        return await this._PTZ(dhlib.enums.PTZ.PTZ_FOCUS_ADD,0,this.focus_speed,0,null,stop);\r\n    }\r\n\r\n    async focusDec(stop) {\r\n        return await this._PTZ(dhlib.enums.PTZ.PTZ_FOCUS_DEC,0,this.focus_speed,0,null,stop);\r\n    }\r\n\r\n    async apertureAdd(stop){\r\n        return await this._PTZ(dhlib.enums.PTZ.PTZ_APERTURE_ADD,0,this.aperture_speed,0,null,stop);\r\n    }\r\n\r\n    async apertureDec(stop) {\r\n        return await this._PTZ(dhlib.enums.PTZ.PTZ_APERTURE_DEC,0,this.aperture_speed,0,null,stop);\r\n    }\r\n\r\n    async move(direction,stop){\r\n        if(!this.supportPTZ) {\r\n            let error =this._error('设备不支持PTZ操作');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        const _d=IPC.Directions;\r\n        switch(direction){\r\n            case _d.top:\r\n                direction=dhlib.enums.PTZ.PTZ_UP;break;\r\n            case _d.left:\r\n                direction=dhlib.enums.PTZ.PTZ_LEFT;break;\r\n            case _d.right:\r\n                direction=dhlib.enums.PTZ.PTZ_RIGHT;break;\r\n            case _d.down:\r\n                direction=dhlib.enums.PTZ.PTZ_DOWN;break;\r\n            case _d.lefttop:\r\n                direction=dhlib.enums.PTZ.EXTPTZ_LEFTTOP;break;\r\n            case _d.leftdown:\r\n                direction=dhlib.enums.PTZ.EXTPTZ_RIGHTDOWN;break;\r\n            case _d.righttop:\r\n                direction=dhlib.enums.PTZ.EXTPTZ_RIGHTTOP;break;\r\n            case _d.rightdown:\r\n                direction=dhlib.enums.PTZ.EXTPTZ_RIGHTDOWN;break;\r\n            default:{\r\n                assert.ok(false);\r\n                direction=-1;break;\r\n            }\r\n        }\r\n        return await this._PTZ(direction,this.v_speed,this.h_speed,0,null,stop);\r\n    }\r\n\r\n    async moveToPoint(x,y,z){\r\n        let pos=new dhlib.structs.PTZ_CONTROL_ABSOLUTELY({\r\n            stuPosition:new dhlib.structs.PTZ_SPACE_UNIT({nPositionX:x,nPositionY:y,nZoom:z}),\r\n            stuSpeed:new dhlib.structs.PTZ_SPEED_UNIT({fPositionX:1.0,fPositionY:1.0,fZoom:1.0})\r\n        });\r\n        return await this._PTZ(dhlib.enums.PTZ.EXTPTZ_MOVE_ABSOLUTELY,0,0,0,pos);\r\n    }\r\n\r\n    async moveToPreset(pt){\r\n        if(!this.supportPTZ) {\r\n            let error =this._error('设备不支持PTZ操作');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        if(pt.preset){\r\n            return await this._PTZ(dhlib.enums.PTZ.PTZ_POINT_MOVE,0,pt.preset,0);\r\n        }\r\n        else{\r\n            return await this.moveToPoint(pt.x,pt.y,pt.z);\r\n        }\r\n    }\r\n/*暂时不启用\r\n    //标记当前位置未新的预置点，标题如示，删除预置点通过返回的参数对象进行操作\r\n    async setPreset(caption){\r\n        throw new Error('未实现函数setPreset');\r\n        if(!this.supportPTZ) {\r\n            let error =this._error('设备不支持PTZ操作');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        //判断名字是否已经存在，则加入对应的点,同一个位置不同的名称可以重复加入\r\n        assert.ok(!this.existsPreset(caption));\r\n        //let nameBuffer=dhlib.utils.utf82Mbcs(name);\r\n        return Promise.all([this.getPoint(),this._getNextPresets()]).then((values)=>{\r\n           return this._PTZ(dhlib.enums.PTZ.PTZ_POINT_SET,0,values[1]).then(()=>{\r\n                    //{x,y,z,preset,name}\r\n                let ret=_.extend(values[0],{preset:values[1]});\r\n                //IPC.prototype.setPreset.call(this,name,ret);\r\n                super.setPreset(caption,ret);\r\n                return Promise.resolve(ret);\r\n           });\r\n        });\r\n    }\r\n\r\n    async removePreset(preset){\r\n        throw new Error('未实现函数removePreset');\r\n    }\r\n\r\n    //获取下一个预置点的编号，大华通过编号移动预置点，标题在移动时在画面上显示\r\n    async _getNextPresets(){\r\n        let lst=await this._getPresets();\r\n        let ret=lst.length+1;\r\n        for(let i=0;i<lst.length;i++){\r\n            if(lst[i].nIndex!==i+1){\r\n                ret=i+1;\r\n            }\r\n        }\r\n        return ret;\r\n    }\r\n\r\n    //获取所有的预置点信息\r\n    async _getPresets(){\r\n        //BYTE 个预置点最多\r\n        await this.connect();\r\n        let PresetType=ArrayType(dhlib.structs.NET_PTZ_PRESET);\r\n        let plst=new PresetType(255);\r\n        let lst=new dhlib.structs.NET_PTZ_PRESET_LIST({\r\n            'dwSize':dhlib.structs.NET_PTZ_PRESET_LIST.size,\r\n            'dwMaxPresetNum':255,//1~255\r\n            'dwRetPresetNum':255,\r\n            'pstuPtzPorsetList':plst.buffer\r\n        });\r\n        let nLenRet=ref.alloc('int');\r\n        let bok=dhlib.functions.CLIENT_QueryDevState(\r\n            this._loginID,\r\n            dhlib.consts.DH_DEVSTATE_PTZ_PRESET_LIST,\r\n            lst.ref(),\r\n            dhlib.structs.NET_PTZ_PRESET_LIST.size,\r\n            nLenRet,\r\n            1000\r\n        );\r\n        await this.disConnect();\r\n        if(!bok){\r\n            let error =this._error('获取预置点列表发生错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n\r\n            return await Promise.reject(error);\r\n        }\r\n        let presets=[];\r\n        for(let i=0;i<lst.dwRetPresetNum;i++){\r\n            presets.push({\r\n                'nIndex':plst[i].nIndex,\r\n                'szName':dhlib.utils.mbcs2Utf8(plst[i].szName.buffer)\r\n            });\r\n        }\r\n        return _.sortBy(presets,['nIndex']);\r\n    }\r\n*/\r\n    //获得当前球机坐标xyz\r\n    async getPoint(){\r\n        if(!this.supportPTZ) {\r\n            let error =this._error('设备不支持PTZ操作');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        await this.connect();\r\n        let nLenRet=ref.alloc('int');\r\n        let location=dhlib.structs.DH_PTZ_LOCATION_INFO();\r\n        let bok=await dhlib.asyncFunctions.CLIENT_QueryDevState(\r\n            this._loginID,\r\n            dhlib.consts.DH_DEVSTATE_PTZ_LOCATION,\r\n            location.ref(),\r\n            dhlib.structs.DH_PTZ_LOCATION_INFO.size,\r\n            nLenRet,\r\n            1000\r\n        );\r\n        await this.disConnect();\r\n        if(!bok){\r\n            let error =this._error('获取球机为止发生错误');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        assert.ok(nLenRet.deref()===dhlib.structs.DH_PTZ_LOCATION_INFO.size);\r\n        return {\r\n            x:location.nPTZPan,\r\n            y :location.nPTZTilt,\r\n            z :location.nPTZZoom\r\n        };\r\n    }\r\n\r\n    async _alarm(open){\r\n        if(!this.supportAlarm){\r\n            let error =this._error('设备不支持报警输出');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        await this.connect();\r\n        let ALARMCTRL_PARAM = dhlib.structs.ALARMCTRL_PARAM;\r\n        let ap = new ALARMCTRL_PARAM({\r\n            dwSize: ALARMCTRL_PARAM.size,\r\n            nAlarmNo: 0,\r\n            nAction: (open ? 1:0)\r\n        });\r\n        //dhlib.enums.CTRL_TYPE.TRIGGER_ALARM_OUT\r\n        let ok=await dhlib.asyncFunctions.CLIENT_ControlDevice(this._loginID,101,ap.ref(), 1000);\r\n        await this.disConnect();\r\n        if (ok!==0) {\r\n            this.emit(open?IPC.Events.Alarm:IPC.Events.AlarmStop,this.log(`报警输出已${open?'打开':'关闭'}`));\r\n            return;\r\n        }\r\n        this.options.fn_alarm=false;\r\n        let error =this._error('报警指令未发出');\r\n        //this.emit(IPC.Events.Error,error);\r\n        return await Promise.reject(error);\r\n    }\r\n\r\n    async alarm(){\r\n        return await this._alarm(true);\r\n    }\r\n    async stopAlarm(){\r\n        return await this._alarm(false);\r\n    }\r\n\r\n    async setVolume(pt){\r\n        if(!this._playID){\r\n            let error =this._error('打开视频端口后使用');\r\n            //this.emit(IPC.Events.Error,error);\r\n            return await Promise.reject(error);\r\n        }\r\n        if(await dhlib.asyncFunctions.CLIENT_SetVolume(this._playID,pt)){\r\n            return;\r\n        }\r\n        let error =this._error('设置音量异常');\r\n        //this.emit(IPC.Events.Error,error);\r\n        return await Promise.reject(error);\r\n    }\r\n\r\n\r\n    static async discovery(cb,timeout=10000){\r\n        let callback=dhlib.callbacks.fSearchDevicesCB((data/*,userData*/)=>{\r\n            let buf=dhlib.utils.readBuffer(data,dhlib.structs.DEVICE_NET_INFO_EX.size);\r\n            let dataClone=Buffer.from(buf);\r\n            let ipcData=new dhlib.structs.DEVICE_NET_INFO_EX(dataClone);\r\n            let ipcInfo=dhlib.utils.structParser(dhlib.structs.DEVICE_NET_INFO_EX,ipcData);\r\n            if(ipcInfo.szDetailType.indexOf(\"IPC\")!==0) return;\r\n            if(ipcInfo.iIPVersion-0!==4)return;\r\n            cb({ip:ipcInfo.szIP,port:ipcInfo.nPort});\r\n        });\r\n        let handle=await dhlib.asyncFunctions.CLIENT_StartSearchDevices(callback,ref.NULL,ref.NULL);\r\n        return new Promise((resolve,reject)=>{\r\n            if(0===handle) return reject(`启用搜索异常，内部错误码：${DHIPC.lastError}`);\r\n            setTimeout(()=>{\r\n                dhlib.asyncFunctions.CLIENT_StopSearchDevices(handle);\r\n                cb(null);\r\n                resolve();\r\n            },timeout||10000);\r\n        });\r\n    }\r\n}\r\n\r\nexports=module.exports=DHIPC;\r\n\r\n/*\r\niIPVersion:4\r\nszIP:192.168.1.92\r\nnPort:37777\r\nszSubmask:255.255.255.0\r\nszGateway:192.168.1.1\r\nszMac:4c:11:bf:a9:41:a9\r\nszDeviceType:IPC-HDW4125C\r\nbyManuFactory:0\r\nbyDefinition:0\r\nbDhcpEn:false\r\nbyReserved1:0\r\nverifyData:\r\nszSerialNo:1E00400PAX01524\r\nszDevSoftVersion:\r\nszDetailType:IPC-HDW4125C\r\nszVendor:\r\nszDevName:\r\nszUserName:\r\nszPassWord:\r\nnHttpPort:80\r\nwVideoInputCh:0\r\nwRemoteVideoInputCh:0\r\nwVideoOutputCh:0\r\nwAlarmInputCh:0\r\nwAlarmOutputCh:0\r\ncReserved:\r\n\r\niIPVersion:4\r\nszIP:192.168.1.100\r\nnPort:37777\r\nszSubmask:255.255.255.0\r\nszGateway:192.168.1.1\r\nszMac:4c:11:bf:01:cf:dc\r\nszDeviceType:NVR\r\nbyManuFactory:0\r\nbyDefinition:0\r\nbDhcpEn:false\r\nbyReserved1:0\r\nverifyData:2302\r\nszSerialNo:PZA4MM155WCEO4N\r\nszDevSoftVersion:\r\nszDetailType:NVR\r\nszVendor:\r\nszDevName:\r\nszUserName:\r\nszPassWord:\r\nnHttpPort:80\r\nwVideoInputCh:0\r\nwRemoteVideoInputCh:0\r\nwVideoOutputCh:0\r\nwAlarmInputCh:0\r\nwAlarmOutputCh:0\r\ncReserved:\r\n */"]}