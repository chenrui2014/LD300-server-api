{"version":3,"sources":["../../../src/ipcs/_508/_508_ptz.js"],"names":["PTZ","require","_","globalConfig","global","server_config","config","getConfig","SerialPort","assert","Parser","isLittleEndian","_508","options","each","val","key","defaults","serialPort","focus_speed","clamp","h_speed","v_speed","_connected","_resp","Buffer","alloc","_respExpect","_x","_y","_z","_cmdStop","_cmdStopResp","port","Promise","resolve","reject","receive","buffer","resp","concat","i","length","slice","equal","readInt32LE","expect","cmd","shift","readInt16LE","readInt16BE","_focusAuto","on","e","removeAllListeners","emit","error","innerError","toString","log","err","disConnect","open","setConnected","close","push","name","req","write","_setRespCmd","cmdStop","stop","connect","_sendCmd","_setStopCmd","_ptzStop","disConnectDelay","setTimeout","auto_close","respCmdStop","ptzStop","A20009","_lens","z","xor","then","catch","direction","x","y","Directions","left","right","top","down","_zoomStop","A1000B","promiseX","promiseY","promiseZ","all","toInteger","A1000F","req2","p1","p2","p3","_zoomTo","pos","result","ctrl1","ctrl2","data1","data2","from","data","exports","module"],"mappings":"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","file":"_508_ptz.js","sourcesContent":["/**\r\n * Created by Luky on 2017/7/5.\r\n */\r\n\r\nconst PTZ=require('../base/ptz');\r\nconst _=require('lodash');\r\nconst globalConfig=global.server_config||require('../../config/config');\r\nconst config=globalConfig.getConfig('_508_config.json');\r\nconst SerialPort = require('serialport');\r\n//const ByteLength = SerialPort.parsers.ByteLength;\r\n//const Delimiter = SerialPort.parsers.Delimiter;\r\n//const Delimiter = require('./Delimiter');\r\nconst assert=require('assert');\r\nconst {Parser} =require('../../log/log');\r\nconst isLittleEndian = require('utils-is-little-endian');\r\n\r\n/*\r\nconst workType={\r\n    'chaxun':1,\r\n    'dangan':2,//单杆，用于移动\r\n    'yindao':3,//引导，定点移动\r\n    'shaomiao':4\r\n};*/\r\n\r\n//不用要及时关闭\r\nclass _508 extends PTZ{\r\n    constructor(options){\r\n        super();\r\n        _.each({'port':''},(val,key)=>{this[key]=options[key]||val;});\r\n        _.each({\r\n            'focus_speed':config['focusSpeed']\r\n            ,'h_speed':config['hSpeed']\r\n            ,'v_speed':config['vSpeed']\r\n            ,'stopCmdDelay':config['stopCmdDelay']\r\n            ,'auto_close':(config['autoClose']||60000)\r\n        },(val,key)=>{this[key]=(key in options)?options[key]:val;});\r\n        this.options=_.defaults(this.options.serialPort||{},config.options,{\r\n            'baudRate': 9600,\r\n            'stopBits': 1,\r\n            'dataBits': 8,\r\n            'parity':'none',\r\n            'cmdDelay':6000,\r\n            'autoOpen': false\r\n        });\r\n        this.focus_speed=_.clamp(this.focus_speed,0x32,0xFA);\r\n        this.h_speed=_.clamp(this.h_speed,1,6000);\r\n        this.v_speed=_.clamp(this.v_speed,1,6000);\r\n        this._connected=false;\r\n        this._resp=Buffer.alloc(0);\r\n        this._respExpect=[];\r\n        this._x=-1;this._y=-1;this._z=0;\r\n        this._cmdStop=null;\r\n        this._cmdStopResp=null;\r\n        //this._servo_worktype=0;\r\n        Parser(this,'_508_ptz.js',{port:this.port});\r\n    }\r\n\r\n    //由于是公用的串口，使用完需要立刻关闭，所以外部调用测试通过后需要立即关闭\r\n    async _connect(){\r\n        return new Promise((resolve,reject)=>{\r\n            let port = new SerialPort(this.port, this.options);\r\n            let receive=(buffer)=>{\r\n                let resp=this._resp=Buffer.concat([this._resp,buffer]);\r\n                while(true){\r\n                    let i=0;\r\n                    while(i<resp.length&&resp[i]!==0xA1&&resp[i]!==0xA2){\r\n                        i++;\r\n                    }\r\n                    if(i>0)resp=this._resp=resp.slice(i);\r\n                    if(resp.length<9) return;\r\n\r\n                    if(resp[0]===0xA1&&resp.length>=11){//伺服命令\r\n                        assert.equal(resp[10],0xAF);\r\n                        if(resp[3]===0x30&&resp[4]===0x58){//查询位置x返回\r\n                            //低位在前\r\n                            this._x=resp.readInt32LE(5)*0.0001;\r\n                        }\r\n                        if(resp[3]===0x30&&resp[4]===0x59){//查询位置y返回\r\n                            this._y=resp.readInt32LE(5)*0.0001;\r\n                        }\r\n                        if(resp[3]===0x45&&resp[4]===0x60){\r\n                            //伺服停止命令\r\n                        }\r\n                        /*               if(resp[3]===0x45&&resp[4]===0x50){\r\n                         //扫描模式下，到达扫描点以后会停下来，这个时候需要将焦距移动到预设位置\r\n                         }*/\r\n                        if(this._respExpect.length){\r\n                            let expect=this._respExpect[0];\r\n                            if(expect.cmd[0]===resp[3]&&expect.cmd[1]===resp[4]){\r\n                                this._respExpect.shift();\r\n                                expect.resolve();\r\n                            }\r\n                        }\r\n                        resp=this._resp=resp.slice(11);\r\n                    }\r\n\r\n                    if(resp[0]===0xA2&&resp.length>=9){//白光命令\r\n                        assert.equal(resp[8],0xAF);\r\n                        if(resp[3]===0x56&&resp[4]===0x53){//zoom stop response\r\n                            this._z=(isLittleEndian?resp.readInt16LE(5):resp.readInt16BE(5));\r\n                        }\r\n                        if(resp[3]===0x50&&resp[4]===0x41){//正比例镜头预置点\r\n                            this._z=(isLittleEndian?resp.readInt16LE(5):resp.readInt16BE(5));\r\n                            this._focusAuto();\r\n                        }\r\n                        if(this._respExpect.length){\r\n                            let expect=this._respExpect.shift();\r\n                            if(expect.cmd[0]===resp[3]&&expect.cmd[1]===resp[4]){\r\n                                this._respExpect.shift();\r\n                                expect.resolve();\r\n                            }\r\n                        }\r\n                        resp=this._resp=resp.slice(9);\r\n                    }\r\n                }\r\n            };\r\n\r\n            port.on('close', (e) => {\r\n                //file.close();\r\n                //网线拔掉以后会有关闭事件\r\n                port.removeAllListeners();\r\n                if(this.serialPort) delete this.serialPort;\r\n                port=null;\r\n                e?this.emit('error',this.error(\"508转台端口关闭\",{innerError:(e||e.toString())}))\r\n                :this.log(\"508转台端口关闭\");\r\n            });\r\n\r\n            port.on('error', (err) => {\r\n                this.emit('error',this.error(\"508转台端口未知异常\",{innerError:err.toString()}));\r\n                this.disConnect();\r\n            });\r\n\r\n            port.open((e) =>{\r\n                if (e) {\r\n                    port.removeAllListeners();\r\n                    return reject(e);\r\n                }\r\n                this.setConnected();\r\n                this.log(\"508转台端口已连接\");\r\n                this.serialPort=port;\r\n                //const parser = port.pipe(new ByteLength({length: 9}));\r\n                //const parser = port.pipe(new Delimiter());\r\n                port.on('data', receive);\r\n                resolve();\r\n            });\r\n        });\r\n    }\r\n\r\n    async _disConnect(){\r\n        return new Promise((resolve,reject)=>{\r\n            if(this.serialPort){\r\n                let port=this.serialPort;this.serialPort=null;\r\n                port.close((err=>{\r\n                    if(err){reject(err);return;}\r\n                    resolve();\r\n                }));\r\n                return;\r\n            }\r\n            resolve();\r\n        });\r\n    }\r\n\r\n    _setStopCmd(cmd,resp){\r\n        this._cmdStop=cmd;\r\n        this._cmdStopResp=resp;\r\n    }\r\n\r\n    _setRespCmd(cmd,resolve,reject){\r\n        this._respExpect.push({cmd:cmd,resolve:resolve,reject:reject});\r\n    }\r\n\r\n    async _sendCmd(name,req,resp=null){\r\n        return new Promise((resolve,reject)=>{\r\n            this.log(`向转台发送命令${name}`,{cmd:req.toString('hex')});\r\n            this.serialPort.write(req,'binary',(err)=>{\r\n                if(err) return reject(err);\r\n                if(resp) this._setRespCmd(resp,resolve,reject);\r\n                else resolve();\r\n            });\r\n        });\r\n    }\r\n\r\n    //镜头\r\n    async _lens(name,req,cmdStop=null,stop=false){\r\n        await this.connect();\r\n        await this._sendCmd(name,req,req.slice(3,5));\r\n        if(cmdStop){\r\n            if(!stop){\r\n                this._setStopCmd(cmdStop,cmdStop.slice(3,5));\r\n            }\r\n            else{\r\n                await this._ptzStop(cmdStop,cmdStop.slice(3,5));\r\n            }\r\n        }\r\n        this.disConnectDelay();\r\n    }\r\n\r\n    disConnectDelay(){\r\n        setTimeout(()=>{\r\n            this.disConnect();\r\n        },this.auto_close)\r\n    }\r\n\r\n    async _ptzStop(cmd,resp){\r\n        await this.connect();\r\n        await this._sendCmd('ptzStop',cmd,resp);\r\n        await this.disConnectDelay();\r\n    }\r\n\r\n    async ptzStop(){\r\n        if(this._cmdStop){\r\n            let stop=this._cmdStop,respCmdStop=this._cmdStopResp;\r\n            this._cmdStopResp=this._cmdStop=null;\r\n            await this.ptzStop(stop,respCmdStop);\r\n        }\r\n    }\r\n\r\n    async zoomAdd(stop) {\r\n        let cmd=A20009(0x56,0x41);\r\n        await this._lens('zoomAdd',cmd,A20009(0x56,0x53),!!stop);\r\n        return cmd;\r\n    }\r\n\r\n    async zoomDec(stop) {\r\n        let cmd=A20009(0x56,0x4D);\r\n        await this._lens('zoomDec',cmd,A20009(0x56,0x53),!!stop);\r\n        return cmd;\r\n    }\r\n\r\n    async _zoomStop(){\r\n        let cmd=A20009(0x56,0x53);\r\n        await this._lens('zoomStop',cmd);\r\n        return cmd;\r\n    }\r\n\r\n    async _zoomTo(z){\r\n        //停止命令不确定有\r\n        let cmd=A20009(0x50,0x41,z&0xFF,(z>>8)&0xFF);\r\n        await this._lens('zoomTo',cmd);\r\n        return cmd;\r\n    }\r\n\r\n    async focusAdd(stop) {\r\n        let cmd=A20009(0x46,0x41,this.focus_speed);\r\n        await this._lens('focusAdd',cmd,A20009(0x46,0x53),!!stop);\r\n        return cmd;\r\n    }\r\n\r\n    async focusDec(stop) {\r\n        let cmd=A20009(0x46,0x4D);\r\n        await this._lens('focusDec',cmd,A20009(0x46,0x53),!!stop);\r\n        return cmd;\r\n    }\r\n\r\n    async _focusStop(){\r\n        let cmd=A20009(0x46,0x53);\r\n        await this._lens('focusStop',cmd);\r\n        return cmd;\r\n    }\r\n\r\n    async _focusAuto() {\r\n        //FF开头的是Pelco-D协议 富士能白光自动聚焦\r\n        let cmd=new Buffer([0xFF,0x01,0x00,0x09,0x00,0x02,0/*,0xAF*/]);\r\n        xor(cmd,6);cmd[6]=cmd[6]%100;\r\n        await this.connect();\r\n        await this._sendCmd('focusAuto',cmd).then(()=>{}).catch(()=>{});\r\n        this.disConnectDelay();\r\n    }\r\n\r\n    async apertureAdd(stop) {\r\n        let cmd=A20009(0x49,0x41);\r\n        await this._lens('apertureAdd',cmd,A20009(0x49,0x53),!!stop);\r\n        return cmd;\r\n    }\r\n\r\n    async apertureDec(stop) {\r\n        let cmd=A20009(0x49,0x4D);\r\n        await this._lens('apertureDec',cmd,A20009(0x49,0x53),!!stop);\r\n        return cmd;\r\n    }\r\n\r\n    async _apertureStop() {\r\n        let cmd=A20009(0x49,0x53);\r\n        await this._lens('apertureStop',cmd);\r\n        return cmd;\r\n    }\r\n\r\n    async move(direction,stop){\r\n        let x=0,y=0;\r\n        if((direction&PTZ.Directions.left)>0){\r\n            x=-this.h_speed;\r\n        }\r\n        else if((direction&PTZ.Directions.right)>0){\r\n            x=this.h_speed\r\n        }\r\n        if((direction&PTZ.Directions.top)>0){\r\n            y=this.v_speed;\r\n        }\r\n        else if((direction&PTZ.Directions.down)>0){\r\n            y=-this.v_speed;\r\n        }\r\n\r\n        //11\r\n        let req=new Buffer([0xA1,0x00,0x0B,0x4D,0x58,(x>>8)&0xFF,x&0xFF,(y>>8)&0xFF,y&0xFF,0,0xAF]);\r\n        xor(req,9);\r\n        let cmdStop=this._cmdStop=new Buffer([0xA1,0x00,0x0B,0x4D,0x58,0,0,0,0,0,0xAF]);\r\n        xor(cmdStop,9);\r\n        await this.connect();\r\n        await this._sendCmd('move',req,null);\r\n        if(!stop){\r\n            this._setStopCmd(cmdStop);\r\n        }\r\n        else{\r\n            await this._ptzStop(cmdStop);\r\n        }\r\n        this.disConnectDelay();\r\n        return req;\r\n    }\r\n\r\n    async getPoint(){\r\n        await this.connect();\r\n        await this._zoomStop();\r\n        //启动上传功能，防止没有启动照成无法找到数据\r\n        await this._sendCmd('getPoint-startup',A1000B(0x51,0x52,0x00));\r\n        let promiseX=new Promise((resolve,reject)=>{this._setRespCmd([0x30,0x58],resolve,reject);});\r\n        let promiseY=new Promise((resolve,reject)=>{this._setRespCmd([0x30,0x59],resolve,reject);});\r\n        let promiseZ=new Promise((resolve,reject)=>{this._setRespCmd([0x56,0x53],resolve,reject);});\r\n        //查询\r\n        await Promise.all([\r\n            this._sendCmd('getPoint-xy',A1000B(0x51,0x50,0x00)),\r\n            this._sendCmd('getPoint-z-zoomStop',A20009(0x56,0x53))\r\n        ]);\r\n        await Promise.all([promiseX,promiseY,promiseZ]);\r\n        this.disConnectDelay();\r\n        return {x:this._x,y:this._y,z:this._z};\r\n    }\r\n\r\n    async moveToPoint(x,y,z){\r\n        x*=100;y*=100;z=_.toInteger(z);\r\n        let req=A1000F(0x50,0x32,x,y);\r\n        let req2=A1000B(0x50,0x30,0x00);//预置位导航命令信息同步\r\n        await this.connect();\r\n        let p1=this._sendCmd('moveToPoint-1',req,[0x45,0x60]);\r\n        let p2=new Promise((resolve,reject)=>{\r\n            setTimeout(()=>{\r\n                this._sendCmd('moveToPoint-2',req2).then(resolve).catch(reject);\r\n            },200);\r\n        });\r\n        let p3=new Promise((resolve,reject)=>{\r\n            setTimeout(()=>{\r\n                this._zoomTo(z).then(resolve).catch(reject);\r\n            },450);\r\n        });\r\n        await Promise.all([p1,p2,p3]);\r\n        this._focusAuto();\r\n        this.disConnectDelay();\r\n    }\r\n\r\n    /*async moveToPreset(preset){\r\n        return await this.moveToPoint(preset.x,preset.y,preset.z);\r\n    }\r\n    setPreset(name){throw new Error('未实现函数setPreset');}\r\n    getPresets(){throw new Error('未实现函数getPresets');}\r\n    removePoint(name){throw new Error('未实现函数removePoint');}\r\n    */\r\n}\r\n\r\nfunction xor(buffer,pos){\r\n    let result=buffer[0];\r\n    for(let x=1;x<pos;x++){\r\n        result=result^buffer[x];\r\n    }\r\n    buffer[pos]=result;\r\n    return buffer;\r\n}\r\n\r\nfunction A20009(ctrl1,ctrl2,data1=0,data2=0){\r\n    let req=Buffer.from([0xA2,0x00,0x09,ctrl1,ctrl2,data1,data2,0,0xAF]);\r\n    return xor(req,7);\r\n}\r\n\r\nfunction A1000F(ctrl1,ctrl2,data1,data2) {\r\n    let req=new Buffer([0xA1,0x00,0x0F,ctrl1,ctrl2,\r\n        (data1>>24)&0xFF,(data1>>16)&0xFF,(data1>>8)&0xFF,data1&0xFF,\r\n        (data2>>24)&0xFF,(data2>>16)&0xFF,(data2>>8)&0xFF,data2&0xFF,\r\n        0,0xAF]);\r\n    return xor(req,13);\r\n}\r\n\r\nfunction A1000B(ctrl1,ctrl2,data){\r\n    let req=new Buffer([0xA1,0x00,0x0B,ctrl1,ctrl2,\r\n        (data>>24)&0xFF,(data>>16)&0xFF,(data>>8)&0xFF,data&0xFF,\r\n        0,0xAF]);\r\n    return xor(req,9);\r\n}\r\n\r\nexports=module.exports=_508;"]}