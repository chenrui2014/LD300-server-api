{"version":3,"sources":["../../src/controllers/presetController.js"],"names":["require","Parser","logger","PresetController","ctx","data","request","body","info","error","msg","add_preset","result","ip","id","params","delete_preset","_id","edit_preset","query","sort","range","filter","sortObj","JSON","parse","rangeObj","filterObj","sortP","length","pageStart","pageEnd","getTotal","total","pagination","pageSize","find_preset","findAll","hosts","forEach","e","host","_doc","hostId","hostName","find_one"],"mappings":"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","file":"presetController.js","sourcesContent":["/**\r\n * Created by chen on 17-8-23.\r\n */\r\nconst {Parser}=require('../log/log');\r\nconst logger={};\r\nParser(logger,'PresetController.js');\r\n\r\nimport PresetService from '../services/PresetService';\r\nimport HostService from '../services/hostService';\r\nclass PresetController {\r\n    static async add_preset(ctx){\r\n        const data = ctx.request.body;\r\n        logger.info(data);\r\n\r\n        if(!data) return ctx.error={ msg: '发送数据失败!' };\r\n        // const isExist = await PresetService.isExist({ip:data.ip})\r\n        // //const isExist = await CameraModel.findOne({ip:data.ip});\r\n        //\r\n        // if(isExist) return ctx.error={ msg: 'ip为[' + data.ip + ']的预置点ip已存在!' };\r\n\r\n        const result = await PresetService.add_preset(data);\r\n\r\n        let msg = '';\r\n        if(result) {\r\n            msg = '添加预置点'+ data.ip +'成功';\r\n            return ctx.body = {msg:msg,data:data};\r\n        }else{\r\n            msg = '添加失败';\r\n            return ctx.error={msg: msg};\r\n        }\r\n\r\n    }\r\n\r\n    static async delete_preset(ctx) {\r\n        const { id } = ctx.params;\r\n        const result = await PresetService.delete_preset({id:id});\r\n        let msg = '';\r\n        if(result) {\r\n            msg = '删除预置点成功';\r\n            return ctx.body = {msg:msg,data:result};\r\n        }else{\r\n            msg = '删除预置点失败';\r\n            return ctx.error={msg: msg};\r\n        }\r\n\r\n    }\r\n\r\n    static async edit_preset(ctx){\r\n        const data = ctx.request.body;\r\n        logger.info(data);\r\n        let _id = data._id;\r\n        delete data._id;\r\n        const result = await PresetService.edit_preset({_id:_id},data);\r\n        if(result) return ctx.body = {msg:'修改预置点成功',data:result};\r\n        return ctx.error={msg: '修改预置点失败!'};\r\n    }\r\n\r\n    static async find_preset(ctx){\r\n        const { sort,range,filter } = ctx.query;\r\n        let sortObj = JSON.parse(sort);\r\n        let rangeObj = JSON.parse(range);\r\n        let filterObj = JSON.parse(filter);\r\n        let sortP = {};\r\n        if(sortObj && sortObj.length >=2){\r\n            if('ASC' ===sortObj[1]){\r\n                sortP[sortObj[0]] = 1\r\n            }else{\r\n                sortP[sortObj[0]] = -1\r\n            }\r\n        }\r\n\r\n        let pageStart = 0,pageEnd = 0;\r\n        if(rangeObj && rangeObj.length >=2){\r\n            pageStart = rangeObj[0];\r\n            pageEnd = rangeObj[1];\r\n        }\r\n\r\n        const total = await PresetService.getTotal();\r\n\r\n        const pagination = {};\r\n        pagination.pageStart = pageStart;\r\n        pagination.pageSize = pageEnd-pageStart+1;\r\n\r\n        let result = await PresetService.find_preset(filterObj,sortP,pagination);\r\n        const hosts = await HostService.findAll();\r\n\r\n        result.forEach(function (e) {\r\n            hosts.forEach(function (host) {\r\n                if(e._doc.hostId === host._doc.id) e._doc.hostName = host._doc.hostName;\r\n                //return;\r\n            });\r\n        });\r\n        if(result) return ctx.body = {msg:'查询预置点',data:result,total:total};\r\n        return ctx.error={msg: '没有找到预置点!'};\r\n    }\r\n\r\n    static async find_preset_noPage(ctx){\r\n        const { sort} = ctx.query;\r\n        let sortObj = JSON.parse(sort);\r\n        let sortP = {};\r\n        if(sortObj && sortObj.length >=2){\r\n            if('ASC' ===sortObj[1]){\r\n                sortP[sortObj[0]] = 1\r\n            }else{\r\n                sortP[sortObj[0]] = -1\r\n            }\r\n        }\r\n        let result = await PresetService.findAll(sortP);\r\n        if(result) return ctx.body = {msg:'查询预置点',data:result};\r\n        return ctx.error={msg: '没有找到预置点!'};\r\n    }\r\n\r\n    static async find_one(ctx){\r\n        const { id } = ctx.params;\r\n        const result = await PresetService.find_one(id);\r\n        if(result) ctx.body = {msg:'查询预置点',data:result};\r\n        return ctx.error = {msg: '没有找到预置点!'};\r\n    }\r\n\r\n}\r\n\r\nexport default PresetController;"]}