{"version":3,"sources":["../../../src/servers/cache/_valve_pipe.js"],"names":["Transform","require","_","assert","EventEmitter","List","capacity","_buffer","Buffer","allocUnsafe","_length","target","start","copy","length","buffer","console","warn","tmp","Cache","timeout","open","_timeout","_datas","Array","Math","floor","i","_pos","_lastTime","_output","buf","enc","next","push","dispatch","append","current","curSecond","j","lst","clear","data","log","pos","len","p","copyTo","Date","getTime","exports","module"],"mappings":";;;;;;;;;;AAAA;;;;AAIA,IAAMA,YAAUC,QAAQ,QAAR,EAAkBD,SAAlC;AACA,IAAME,IAAED,QAAQ,QAAR,CAAR;AACA,IAAME,SAAOF,QAAQ,QAAR,CAAb;AACA,IAAMG,eAAeH,QAAQ,QAAR,EAAkBG,YAAvC;;IAEMC,I;AACF,kBAAYC,QAAZ,EAAqB;AAAA;;AACjBA,mBAASA,YAAU,GAAnB;AACA,aAAKC,OAAL,GAAaC,OAAOC,WAAP,CAAmBH,QAAnB,CAAb;AACA,aAAKI,OAAL,GAAa,CAAb;AACH;;;;+BAIMC,M,EAAOC,K,EAAM;AAChB,gBAAG,CAAC,KAAKF,OAAT,EAAkB,OAAO,CAAP;AAClB,iBAAKH,OAAL,CAAaM,IAAb,CAAkBF,MAAlB,EAAyBC,KAAzB,EAA+B,CAA/B,EAAiC,KAAKE,MAAtC;AACA,mBAAO,KAAKA,MAAZ;AACH;;;gCACM;AACH,iBAAKJ,OAAL,GAAa,CAAb;AACH;;;+BACMK,M,EAAO;AACV,gBAAG,KAAKR,OAAL,CAAaO,MAAb,GAAoB,KAAKJ,OAAzB,GAAiCK,OAAOD,MAA3C,EAAkD;AAC9CE,wBAAQC,IAAR,kCAAwB,KAAKV,OAAL,CAAaO,MAAb,GAAoB,IAA5C,UAAqD,CAAC,KAAKP,OAAL,CAAaO,MAAb,GAAoB,IAAEC,OAAOD,MAA9B,IAAsC,IAA3F;AACA,oBAAII,MAAIV,OAAOC,WAAP,CAAmB,KAAKF,OAAL,CAAaO,MAAb,GAAoB,IAAEC,OAAOD,MAAhD,CAAR;AACA,qBAAKP,OAAL,CAAaM,IAAb,CAAkBK,GAAlB,EAAsB,CAAtB,EAAwB,CAAxB,EAA0B,KAAKR,OAA/B;AACA,uBAAO,KAAKH,OAAZ;AACAQ,uBAAOF,IAAP,CAAYK,GAAZ,EAAgB,KAAKR,OAArB;AACA,qBAAKH,OAAL,GAAaW,GAAb;AACA,qBAAKR,OAAL,IAAcK,OAAOD,MAArB;AACH,aARD,MASI;AACAC,uBAAOF,IAAP,CAAY,KAAKN,OAAjB,EAAyB,KAAKG,OAA9B;AACA,qBAAKA,OAAL,IAAcK,OAAOD,MAArB;AACH;AACJ;;;4BAzBW;AACR,mBAAO,KAAKJ,OAAZ;AACH;;;;;;IA0BCS,K;;;AACF,qBAA4C;AAAA,YAAhCC,OAAgC,uEAAxB,CAAwB;AAAA,YAAtBd,QAAsB,uEAAb,CAAa;AAAA,YAAXe,IAAW,uEAAN,KAAM;;AAAA;;AAAA;;AAExC,cAAKC,QAAL,GAAcF,OAAd;AACA,YAAG,MAAKE,QAAR,EAAiB;AACb;AACA,kBAAKC,MAAL,GAAY,IAAIC,KAAJ,CAAUJ,OAAV,CAAZ;AACAd,uBAASA,YAAW,MAAIc,OAAxB;AACAd,uBAASmB,KAAKC,KAAL,CAAWpB,WAASc,OAApB,CAAT;AACA,iBAAI,IAAIO,IAAE,CAAV,EAAYA,IAAEP,OAAd,EAAsBO,GAAtB,EAA0B;AACtB,sBAAKJ,MAAL,CAAYI,CAAZ,IAAe,IAAItB,IAAJ,CAASC,QAAT,CAAf;AACH;AACJ;AACD,cAAKI,OAAL,GAAa,CAAb;AACA,cAAKkB,IAAL,GAAU,CAAV;AACA,cAAKC,SAAL,GAAe,CAAf;AACA,cAAKC,OAAL,GAAa,KAAb;AACA,YAAGT,IAAH,EAAQ;AACJ,kBAAKA,IAAL;AACH;AAlBuC;AAmB3C;;;;+BAEK;AACF,iBAAKS,OAAL,GAAa,IAAb;AACH;;;gCAEM;AACH,iBAAKA,OAAL,GAAa,KAAb;AACH;;;mCAEUC,G,EAAIC,G,EAAIC,I,EAAK;AACpB,gBAAG,KAAKH,OAAR,EAAgB,KAAKI,IAAL,CAAU,KAAKC,QAAL,CAAcJ,GAAd,CAAV,EAAhB,KACK,KAAKK,MAAL,CAAYL,GAAZ;AACLE;AACH;;;gCAEO;AACJ,gBAAII,UAAQC,WAAZ;AACA,iBAAKT,SAAL,GAAe,KAAKA,SAAL,IAAgBQ,OAA/B;AACA,gBAAG,KAAKR,SAAL,KAAiBQ,OAAjB,IAA0B,KAAK3B,OAAlC,EAA0C;AACtC,qBAAI,IAAIiB,IAAE,KAAKE,SAAL,GAAe,CAArB,EAAuBU,IAAE,CAA7B,EAA+BZ,KAAGU,OAAH,IAAYE,IAAE,KAAKjB,QAAlD,EAA2DK,GAA3D,EAA+D;AAC3D,wBAAIa,MAAI,KAAKjB,MAAL,CAAYI,IAAE,KAAKL,QAAnB,CAAR;AACA,yBAAKZ,OAAL,IAAc8B,IAAI1B,MAAlB;AACA0B,wBAAIC,KAAJ;AACH;AACJ;AACD,mBAAOJ,OAAP;AACH;;;+BAEMK,I,EAAK;AACR,gBAAG,CAAC,KAAKpB,QAAT,EAAmB;AACnB,iBAAKO,SAAL,GAAe,KAAKY,KAAL,EAAf;AACA,iBAAKb,IAAL,GAAU,KAAKC,SAAL,GAAe,KAAKP,QAA9B;AACC,gBAAG,CAACoB,IAAD,IAAO,CAACA,KAAK5B,MAAhB,EAAwB;AACzB;AACAE,oBAAQ2B,GAAR,kBAAiB,KAAKf,IAAtB,gDAAuCH,KAAKC,KAAL,CAAW,KAAKH,MAAL,CAAY,KAAKK,IAAjB,EAAuBd,MAAvB,GAA8B,IAAzC,CAAvC,6CAA+FW,KAAKC,KAAL,CAAW,KAAKH,MAAL,CAAY,KAAKK,IAAjB,EAAuBrB,OAAvB,CAA+BO,MAA/B,GAAsC,IAAjD,CAA/F;AACA,iBAAKS,MAAL,CAAY,KAAKK,IAAjB,EAAuBQ,MAAvB,CAA8BM,IAA9B;AACA,iBAAKhC,OAAL,IAAcgC,KAAK5B,MAAnB;AACH;;;iCAEQ4B,I,EAAK;AACV,gBAAG,CAAC,KAAKhC,OAAT,EAAkB,OAAOgC,IAAP;AAClB,gBAAI5B,SAAO,KAAKJ,OAAL,IAAcgC,OAAKA,KAAK5B,MAAV,GAAiB,CAA/B,CAAX;AACA,gBAAIC,SAAOP,OAAOC,WAAP,CAAmBK,MAAnB,CAAX;AACA,gBAAI8B,MAAI,KAAKhB,IAAb;AAAA,gBAAkBiB,MAAI,CAAtB;AACA,iBAAI,IAAIlB,IAAE,CAAN,EAAQmB,IAAE,CAACF,MAAI,CAAL,IAAQ,KAAKtB,QAA3B,EAAoCK,IAAE,KAAKL,QAA3C,EAAoDK,GAApD,EAAwD;AACpD,oBAAIa,MAAI,KAAKjB,MAAL,CAAYuB,CAAZ,CAAR;AACAA,oBAAE,CAACA,IAAE,CAAH,IAAM,KAAKxB,QAAb;AACAuB,uBAAKL,IAAIO,MAAJ,CAAWhC,MAAX,EAAkB8B,GAAlB,CAAL;AACAL,oBAAIC,KAAJ;AACH;AACD,gBAAGC,IAAH,EAAQ;AACJA,qBAAK7B,IAAL,CAAUE,MAAV,EAAiB8B,GAAjB;AACH;AACD,iBAAKnC,OAAL,GAAa,CAAb;AACA,mBAAOK,MAAP;AACH;;;;EA5Eef,S;;AA+EpB,SAASsC,SAAT,GAAqB;AACjB,WAAOb,KAAKC,KAAL,CAAW,IAAIsB,IAAJ,GAAWC,OAAX,KAAqB,IAAhC,CAAP;AACH;;AAEDC,UAAQC,OAAOD,OAAP,GAAe/B,KAAvB","file":"_valve_pipe.js","sourcesContent":["/**\r\n * Created by Luky on 2017/7/19.\r\n */\r\n\r\nconst Transform=require('stream').Transform;\r\nconst _=require('lodash');\r\nconst assert=require('assert');\r\nconst EventEmitter = require('events').EventEmitter;\r\n\r\nclass List{\r\n    constructor(capacity){\r\n        capacity=capacity||512;\r\n        this._buffer=Buffer.allocUnsafe(capacity);\r\n        this._length=0;\r\n    }\r\n    get length(){\r\n        return this._length;\r\n    }\r\n    copyTo(target,start){\r\n        if(!this._length) return 0;\r\n        this._buffer.copy(target,start,0,this.length);\r\n        return this.length;\r\n    }\r\n    clear(){\r\n        this._length=0;\r\n    }\r\n    append(buffer){\r\n        if(this._buffer.length-this._length<buffer.length){\r\n            console.warn(`内存增长(KB)${this._buffer.length/1024}=>${(this._buffer.length+3*buffer.length)/1024}`);\r\n            let tmp=Buffer.allocUnsafe(this._buffer.length+3*buffer.length);\r\n            this._buffer.copy(tmp,0,0,this._length);\r\n            delete this._buffer;\r\n            buffer.copy(tmp,this._length);\r\n            this._buffer=tmp;\r\n            this._length+=buffer.length;\r\n        }\r\n        else{\r\n            buffer.copy(this._buffer,this._length);\r\n            this._length+=buffer.length;\r\n        }\r\n    }\r\n}\r\n\r\nclass Cache extends Transform{\r\n    constructor(timeout=0,capacity=0,open=false){\r\n        super();\r\n        this._timeout=timeout;\r\n        if(this._timeout){\r\n            //不提供缓存功能的阀门，来的数据都丢掉\r\n            this._datas=new Array(timeout);\r\n            capacity=capacity||(512*timeout);\r\n            capacity=Math.floor(capacity/timeout);\r\n            for(let i=0;i<timeout;i++){\r\n                this._datas[i]=new List(capacity);\r\n            }\r\n        }\r\n        this._length=0;\r\n        this._pos=0;\r\n        this._lastTime=0;\r\n        this._output=false;\r\n        if(open){\r\n            this.open();\r\n        }\r\n    }\r\n\r\n    open(){\r\n        this._output=true;\r\n    }\r\n\r\n    close(){\r\n        this._output=false;\r\n    }\r\n\r\n    _transform(buf,enc,next){\r\n        if(this._output)this.push(this.dispatch(buf));\r\n        else this.append(buf);\r\n        next();\r\n    }\r\n\r\n    clear() {\r\n        let current=curSecond();\r\n        this._lastTime=this._lastTime||current;\r\n        if(this._lastTime!==current&&this._length){\r\n            for(let i=this._lastTime+1,j=0;i<=current&&j<this._timeout;i++){\r\n                let lst=this._datas[i%this._timeout];\r\n                this._length-=lst.length;\r\n                lst.clear();\r\n            }\r\n        }\r\n        return current;\r\n    }\r\n\r\n    append(data){\r\n        if(!this._timeout) return;\r\n        this._lastTime=this.clear();\r\n        this._pos=this._lastTime%this._timeout;\r\n         if(!data||!data.length) return;\r\n        //console.log(`pos:${this._pos}`);\r\n        console.log(`位置${this._pos}当前缓存大小(KB)${Math.floor(this._datas[this._pos].length/1024)},实际内存大小${Math.floor(this._datas[this._pos]._buffer.length/1024)}`);\r\n        this._datas[this._pos].append(data);\r\n        this._length+=data.length;\r\n    }\r\n\r\n    dispatch(data){\r\n        if(!this._length) return data;\r\n        let length=this._length+(data?data.length:0);\r\n        let buffer=Buffer.allocUnsafe(length);\r\n        let pos=this._pos,len=0;\r\n        for(let i=0,p=(pos+1)%this._timeout;i<this._timeout;i++){\r\n            let lst=this._datas[p];\r\n            p=(p+1)%this._timeout;\r\n            len+=lst.copyTo(buffer,len);\r\n            lst.clear();\r\n        }\r\n        if(data){\r\n            data.copy(buffer,len);\r\n        }\r\n        this._length=0;\r\n        return buffer;\r\n    }\r\n}\r\n\r\nfunction curSecond() {\r\n    return Math.floor(new Date().getTime()/1000);\r\n}\r\n\r\nexports=module.exports=Cache;"]}