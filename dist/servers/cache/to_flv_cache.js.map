{"version":3,"sources":["../../../src/servers/cache/to_flv_cache.js"],"names":["Writable","require","NALU","SPSParser","config","global","server_config","FLV","_","assert","ADTS","h264Prefix","Buffer","from","Parser","H264AndAACCache","video","audio","objectMode","_hasVideo","_hasAudio","_size_video_totle","_size_audio_totle","_size_video","_size_audio","clear","_sps","_pps","_adts","_slices","_ready","_clients","metadata","duration","filesize","hasVideo","hasAudio","title","encoder","videocodecid","VideoEncodings","AVC","framerate","width","height","videodatarate","audiocodecid","AudioEncodings","AAC","audiodatarate","audiosamplerate","audiosamplesize","stereo","client","remove","c","log","length","time0","push","_sendHead","slice","clients","each","cb","timestamp","dataType","adts","blocks","freq","audioDuration","_audioDuration","audioTagAVCPackage_AACRowdata_ADST","data","_toVedioTagAVCPackageNALU","key","_getTimestamp","cbs","headBytes","type","scriptTag","tagType","VedioTagAVCPacket_DecorderConfigurationRecord","_avc","profile","profile_compatibility","level","audioTagAVCPackage_AACSpecificConfig_ADST","j","slicei","_sendVideo","_sendAudio","ParseADTSHeader","channel","codec","time","runtimeLength","_VedioReady","nalu","unit","TYPES","SPS","sps","parseSPS","present_size","profile_idc","level_idc","PPS","SEI","isIDR","key_frame","_AudioReady","data_temp","enc","index","indexOf","_pushVedioH264","totle","_pushAudioADTS","iFrame","VedioTagAVCPackageNALU","FrameTypes","KeyFrame","InterFrame","exports","module"],"mappings":"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","file":"to_flv_cache.js","sourcesContent":["/**\r\n * Created by Luky on 2017/8/11.\r\n */\r\n\r\n//const Transform=require('stream').Transform;\r\nconst Writable=require('stream').Writable;\r\nconst NALU=require('../../h264/h264_nalu_parser');\r\nconst SPSParser=require('../../h264/h264_sps_parser');\r\n/*const PPSParser=require('../../h264/h264_pps_parser');\r\nconst SEIParser=require('../../h264/h264_sei_parser');\r\nconst SliceParser=require('../../h264/h264_slice_parser');\r\nconst POC=require('../../h264/h264_poc');*/\r\nconst config=global.server_config||require('../../config/config');\r\nconst FLV=require('../../flv/flv_encoder');\r\nconst _=require('lodash');\r\nconst assert=require('assert');\r\nconst ADTS=require('../../acc/acc_adts_parser');\r\nconst h264Prefix=Buffer.from([0,0,1]);\r\nconst {Parser}=require('../../log/log');\r\n/*let fs=require('fs');\r\nlet file=fs.createWriteStream('d:/audio_flv.test.aac',{\r\n    flags: 'w',\r\n    encoding: null,\r\n    fd: null,\r\n    mode: 0o666,\r\n    autoClose: true\r\n});*/\r\n\r\nclass H264AndAACCache extends Writable{\r\n    constructor(video=true,audio=false){\r\n        super({ objectMode: true });\r\n        this._hasVideo=video;\r\n        this._hasAudio=audio;\r\n        this._size_video_totle=0;\r\n        this._size_audio_totle=0;\r\n        this._size_video=0;\r\n        this._size_audio=0;\r\n        this.clear();\r\n        Parser(this,'to_flv_cache.js');\r\n    }\r\n\r\n    clear(){\r\n        this._sps=null;\r\n        this._pps=null;\r\n        this._adts=null;\r\n        //this._sei=null;\r\n        //sei先不管\r\n        this._slices=[];\r\n        this._ready=false;\r\n        this._clients=[];\r\n        let metadata={\r\n            //文件部分\r\n            duration:0,filesize:0,\r\n            //扩展部分flv.js\r\n            hasVideo:this._hasVideo,\r\n            hasAudio:this._hasAudio,\r\n            //其他\r\n            title: 'lambda 0.1',encoder: 'lambda',\r\n        };\r\n        if(this._hasVideo){\r\n            metadata.videocodecid=FLV.VideoEncodings.AVC;//视频编码方式\r\n            metadata.framerate= 100;//看看100是否能加快直播速度25;//视频帧率\r\n            metadata.width=0;//视频宽度\r\n            metadata.height=0;//视频高度\r\n            metadata.videodatarate= 0;//视频码率\r\n        }\r\n        if(this._hasAudio){\r\n            metadata.audiocodecid=FLV.AudioEncodings.AAC;//音频编码方式\r\n            metadata.audiodatarate=0;//音频采样率,\r\n            metadata.audiosamplerate=0;//音频采样率,\r\n            metadata.audiosamplesize=16;//音频采样位数，采样长度，采样深度\r\n            metadata.stereo=false;//立体声,\r\n        }\r\n        this.metadata=metadata;\r\n        this._size_video_totle=0;\r\n        this._size_audio_totle=0;\r\n        this._size_video=0;\r\n        this._size_audio=0;\r\n    }\r\n\r\n    removeClient(client){\r\n        _.remove(this._clients,(c)=>{return c===client});\r\n        this.log('客户退出',{length:this._clients.length});\r\n    }\r\n\r\n    addClient(client){\r\n        client.time0=0;\r\n        this._clients.push(client);\r\n        this.log('新连入客户',{length:this._clients.length});\r\n        if(this._ready){\r\n            this._sendHead([client]);\r\n        }\r\n    }\r\n\r\n    _sendAudio(slice,clients){\r\n        //if(this._clients.length>0)file.write(slice.data);\r\n        _.each(clients||this._clients,(cb)=>{\r\n            let timestamp=0;\r\n            if(slice.dataType==='data'){\r\n                const adts=slice.adts;\r\n                timestamp=adts.blocks*1024*1000/adts.freq;\r\n                cb.audioDuration=cb.audioDuration||0;\r\n                this._audioDuration+=timestamp;\r\n            }\r\n            cb(FLV.audioTagAVCPackage_AACRowdata_ADST(slice.data,timestamp),slice);\r\n        });\r\n    }\r\n\r\n    _sendVideo(slice,clients){\r\n        _.each(clients||this._clients,(cb)=>{\r\n            cb(H264AndAACCache._toVedioTagAVCPackageNALU(slice.data,slice.key,H264AndAACCache._getTimestamp(cb,slice)),slice);\r\n        });\r\n    }\r\n\r\n    static _getTimestamp(client,slice){\r\n        //if(!client.time0)console.log(`开始时间${slice.time}`);\r\n        client.time0=client.time0||slice.time;\r\n        //返回0，可以即时播放，这里需要通过时间戳加快播放速度\r\n        return /*slice.time-client.time0*/0;\r\n    }\r\n\r\n    _sendHead(cbs){\r\n        _.each(cbs,(cb)=>{\r\n            cb(FLV.headBytes(this._hasVideo,this._hasAudio),{type:'header'});\r\n            cb(FLV.scriptTag(this.metadata),{type:'tag',tagType:'script'});\r\n            if(null!==this._sps&&null!==this._pps)\r\n                cb(FLV.VedioTagAVCPacket_DecorderConfigurationRecord([this._sps],[this._pps],this._avc.profile,this._avc.profile_compatibility,this._avc.level),{type:'tag',tagType:'video',dataType:'head'});\r\n            if(null!==this._adts){\r\n                cb(FLV.audioTagAVCPackage_AACSpecificConfig_ADST(this._adts),{type:'tag',tagType:'audio',dataType:'head'});\r\n            }\r\n        });\r\n        for (let j = 0; j < this._slices.length; j++) {\r\n            let slicei=this._slices[j];\r\n            if(slicei.tagType==='video'){\r\n                this._sendVideo(slicei);\r\n            }\r\n            else{\r\n                this._sendAudio(slicei);\r\n            }\r\n        }\r\n    }\r\n\r\n    /*_toSequenceHander() {\r\n        if(this._sei){\r\n            this.push(FLV.VedioTagAVCPackageNALU(0,0,this._SEIBuffer,FLV.FrameTypes.InterFrame));\r\n        }\r\n    }*/\r\n\r\n    static _toVedioTagAVCPackageNALU(slice,iFrame,timestamp){\r\n        return FLV.VedioTagAVCPackageNALU(slice, (iFrame?FLV.FrameTypes.KeyFrame:FLV.FrameTypes.InterFrame),timestamp);\r\n    }\r\n\r\n    _pushAudioADTS(data){\r\n        let adts=ADTS.ParseADTSHeader(data);\r\n        this._adts=data;\r\n        this.metadata.audiosamplerate=adts.freq;\r\n        this.metadata.stereo=adts.channel>1;\r\n        let slice={type:'tag',tagType:'audio',dataType:'data',codec:'acc',adts:adts,data:data,time:config.runtimeLength()};\r\n        if(!this._hasVideo&&this._slices.length>50){\r\n            this._slices=this._slices.slice(25);\r\n        }\r\n        this._slices.push(slice);\r\n        if(!this._ready&&this._VedioReady){\r\n            this._ready=true;\r\n            this._sendHead(this._clients);\r\n            return;\r\n        }\r\n        if(this._ready)this._sendAudio(slice);\r\n    }\r\n\r\n    get _AudioReady(){\r\n        return !this._hasAudio||this._adts!==null;\r\n    }\r\n\r\n    get _VedioReady(){\r\n        return !this._hasVideo||(this._sps!==null&&this._pps!==null);\r\n    }\r\n\r\n    _pushVedioH264(nalu){\r\n        let unit=new NALU(nalu);\r\n        if(unit.type===NALU.TYPES.SPS){\r\n            if(null!==this._sps) return;\r\n            let sps=SPSParser.parseSPS(nalu);\r\n            this.metadata.width=sps.present_size.width;\r\n            this.metadata.height=sps.present_size.height;\r\n            this._avc={\r\n                profile:sps.profile_idc,\r\n                profile_compatibility:sps.profile_compatibility,\r\n                level:sps.level_idc\r\n            };\r\n            this._sps=nalu;\r\n            return;\r\n        }\r\n        if(unit.type===NALU.TYPES.PPS)\r\n        {\r\n            this._pps=nalu;\r\n            return;\r\n        }\r\n        if(unit.type===NALU.TYPES.SEI){\r\n            return;\r\n        }\r\n        const isIDR=unit.key_frame;\r\n        let slice={type:'tag',tagType:'video',dataType:'data',codec:'h264',data:nalu,key:isIDR,time:config.runtimeLength()};\r\n        if(isIDR){\r\n            this._slices=[slice];\r\n            if(!this._ready&&this._AudioReady){\r\n                this._ready=true;\r\n                this._sendHead(this._clients);\r\n                return;\r\n            }\r\n        }\r\n        else{\r\n            this._slices.push(slice);\r\n        }\r\n        if(this._ready)this._sendVideo(slice);\r\n    }\r\n\r\n    _write(data_temp,enc,cb){\r\n        //不知道为什么数据会被篡改，所以复制一份\r\n        let data=Buffer.from(data_temp);\r\n\r\n        if(this._hasVideo){\r\n            let index;\r\n            if((index=data.slice(0,4).indexOf(h264Prefix))!==-1){\r\n                this._pushVedioH264(data.slice(index+3));\r\n                this._size_video+=data.length;\r\n                if(this._size_video>1024*1024*5){//5MB\r\n                    this._size_video_totle+=this._size_video;\r\n                    this._size_video=0;\r\n                    this.log('接受视频数据增量记录',{totle:this._size_video_totle});\r\n                }\r\n            }\r\n        }\r\n        if(this._hasAudio){\r\n            if(data[0] === 0xff&&((data[1]&0xf0)===0xf0)) {\r\n                this._pushAudioADTS(data);\r\n                this._size_audio+=data.length;\r\n                if(this._size_audio>1024*1024){//1MB\r\n                    this._size_audio_totle+=this._size_audio;\r\n                    this._size_audio=0;\r\n                    this.log('接受音频数据增量记录',{totle:this._size_audio_totle});\r\n                }\r\n            }\r\n        }\r\n        cb();\r\n    }\r\n}\r\n\r\nexports=module.exports=H264AndAACCache;\r\n"]}