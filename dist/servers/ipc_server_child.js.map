{"version":3,"sources":["../../src/servers/ipc_server_child.js"],"names":["id","l","lives","IPCFactory","getIPC","catch","logger","warn","ipc","Live","server","autoClose","getLive","res","log","fn","fault","running","succeed","port","path","openWSS","then","ok","on","send","type","count","length","play","hid","arrchive","fun","params","op","force","stop","handle","_","findIndex","ptzFun","item","Promise","resolve","ptz","now","Date","getTime","lastTime","ptzLock","createID","promise","apply","parseInt","position","limit","innerError","e","toString","freePTZ","getPoint","xyz","point","JSON","parse","x","moveToPoint","y","z","alarm","stopAlarm","getPort","_port","listen","connect","require","http","crypto","config","global","server_config","store","get","process","env","NODE_ENV","_store","argv","pop","runMode","url","Parser","data","desc","param","msg","extend","end","stringify","error","stopArrchive","createServer","req","uri","paths","trim","pathname","split","concat","setHeader","index","indexOf","toLower","statusCode","query","address","processID","pid","err","code","console","source","hash","createHash","update","digest","exports","module"],"mappings":"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","file":"ipc_server_child.js","sourcesContent":["/**\r\n * Created by Luky on 2017/9/4.\r\n */\r\n\r\n//import 'babel-polyfill';\r\n//import connect from '../db';\r\nconst connect =require('../db/index');\r\nconst http = require('http');\r\nconst _=require('lodash');\r\nconst Live=require('./ipc_live_server');\r\nconst getPort=require('get-port');\r\nconst IPCFactory=require('./ipc_factory');\r\nconst crypto=require('crypto');\r\nlet config=global.server_config||require('../config/config');\r\nlet store=_.get(config,'runMode.store','db');\r\nif(process.env.NODE_ENV==='development'||process.env.NODE_ENV==='test'){\r\n    let _store=process.argv.pop();\r\n    if(_store==='file'||_store==='db'){\r\n        config.runMode.store=_store;\r\n    }\r\n}\r\nconst ptzLock=_.get(config,'ipc.ptzLock',15000);\r\nconst url=require('url');\r\nconst logger={};\r\nconst {Parser}=require('../log/log');\r\nlet port=0;\r\n\r\nlet send=function (data){\r\n    if(process.send){\r\n        return process.send(data);\r\n    }\r\n    logger.log('向主进程同步信号',{data});\r\n};\r\n\r\nconst ptzFun=[\r\n    'ptzStop',\r\n    'zoomAdd',\r\n    'zoomDec',\r\n    'focusAdd',\r\n    'focusDec',\r\n    'apertureAdd',\r\n    'apertureDec',\r\n    'move'\r\n];\r\n\r\nlet lives={length:0};\r\n\r\nasync function getLive(id) {\r\n    let l=lives[id];\r\n    if(l) return l;\r\n    let ipc=await IPCFactory.getIPC(id).catch( ()=>{\r\n        logger.warn('请求的摄像头不存在',{id:id});\r\n        return null;\r\n    });\r\n    if(!ipc)return null;\r\n    return lives[id]=new Live(server,ipc,'',{autoClose:true});\r\n}\r\n\r\nfunction fault(res,fn,desc,param,warn=true) {\r\n    let msg=_.extend({type:'fault',fn},param);\r\n    res.end(JSON.stringify(warn?logger.warn(desc,msg):logger.error(desc,msg)));\r\n}\r\n\r\nfunction succeed(res,fn,param,desc) {\r\n    let msg=_.extend({type:'succeed',fn},param);\r\n    res.end(JSON.stringify(logger.log(desc,msg)));\r\n}\r\n\r\nasync function  play(res,id) {\r\n    logger.log('收到播放请求',{id:id,fn:'live'});\r\n    let l=await getLive(id);\r\n    if(!l){\r\n        return fault(res,'live','请求的摄像头不存在',{id});\r\n    }\r\n    if(l.running) {\r\n        return succeed(res,'live',{port:port,path:l.path,id});\r\n    }\r\n    l.openWSS().then((ok)=>{\r\n        if(!ok){\r\n            return fault(res,'live','获取直播流错误',{id},false);\r\n        }\r\n        l.on('close',()=>{\r\n            lives[id]=null;\r\n            send({type:'countChanged',count:--lives.length,id});\r\n        });\r\n        send({type:'countChanged',count:++lives.length,id});\r\n        return succeed(res,'live',{port:port,path:l.path,id});\r\n    })\r\n}\r\n\r\nasync function arrchive(res,id,hid) {\r\n    logger.log('收到存档请求',{id,hid,fn:'arrchive'});\r\n    let l=await getLive(id);\r\n    if(!l) return fault(res,'arrchive','请求的摄像头不存在',{id,hid});\r\n    l.arrchive(hid).then((path)=>{\r\n        send({type:'countChanged',count:++lives.length,id});\r\n        return path?succeed(res,'arrchive',{id,hid,path}):fault(res,'arrchive','发生内部错误，无法存档视频流或无法打开视频流',{id,hid},false);\r\n    });\r\n}\r\n\r\nfunction stopArrchive(res,id) {\r\n    logger.log('收到存档终止请求',{id,fn:'stopArrchive'});\r\n    let l= lives[id];\r\n    if(!l) return fault(res,'stopArrchive','请求的摄像头不存在',{id});\r\n    l.stopArrchive(id);\r\n    send({type:'countChanged',count:--lives.length,id});\r\n    return succeed(res,'stopArrchive',{id});\r\n}\r\n\r\nasync function ptz(res,id,fun,params){\r\n    logger.log('收到ptz申请',{id,fn:'ptz',op:fun});\r\n    params=params||{};\r\n    const force=!!params.force;\r\n    const stop=params.stop!=='0';\r\n    let handle=params.handle;\r\n    if(_.findIndex(ptzFun,(item)=>{return fun===item;})===-1) {\r\n        return fault(res,'ptz','错误的PTZ命令',{op:fun});\r\n    }\r\n    let ipc=await IPCFactory.getIPC(id).catch(()=>{\r\n        return Promise.resolve(null);\r\n    });\r\n    if(!ipc){\r\n        return fault(res,'ptz','请求的摄像头不存在',{id});\r\n    }\r\n    ipc.ptz=ipc.ptz||{};\r\n    const now=new Date().getTime();\r\n    if(!ipc.ptz.handle||force||(ipc.ptz.handle!==handle&&now-ipc.ptz.lastTime>ptzLock)){\r\n        ipc.ptz.handle=handle=createID();\r\n    }\r\n    else if(ipc.ptz.handle!==handle){\r\n        return fault(res,'ptz','ptz暂时由其他人控制中，请等待',{id});\r\n    }\r\n    ipc.ptz.lastTime=now;\r\n    let promise=fun==='move'?ipc[fun].apply(ipc,[parseInt(params.position)||1,stop]):ipc[fun].apply(ipc,[stop]);\r\n    promise.then(()=>{\r\n        succeed(res,'ptz',{handle,id,op:fun,limit:ptzLock})\r\n    }).catch(e=>{\r\n        ipc.ptz.handle=null;\r\n        return fault(res,'ptz','内部处理异常',{id,op:fun,innerError:(e||'').toString()},false);\r\n    });\r\n}\r\n\r\n/*\r\napplyMic(id){}\r\nreleaseMic(handle,id){}\r\nsendMic(id,data){}\r\n*/\r\n\r\nasync function freePTZ(res,id,params) {\r\n    params=params||{};\r\n    let handle=params.handle;\r\n    logger.log('收到ptz释放申请',{id,fn:'freePTZ',handle});\r\n    if(!handle){\r\n        return fault(res,'freePTZ','不具备PTZ的控制权',{id});\r\n    }\r\n    let ipc=await IPCFactory.getIPC(id).catch(()=>{\r\n        return Promise.resolve(null);\r\n    });\r\n    if(!ipc)return fault(res,'freePTZ','请求的摄像头不存在',{id});\r\n    if(handle===ipc.ptz.handle){\r\n        ipc.ptz.handle='';\r\n        return succeed(res,'freePTZ',{id,handle});\r\n    }\r\n    return fault(res,'freePTZ','不具备PTZ的控制权',{id,handle});\r\n}\r\n\r\nasync function getPoint(res,id){\r\n    logger.log('收到获取球机坐标申请',{id});\r\n    let ipc=await IPCFactory.getIPC(id).catch(()=>{\r\n        return Promise.resolve(null);\r\n    });\r\n    if(!ipc)return fault(res,'getPoint','请求的摄像头不存在',{id});\r\n    let xyz=await ipc.getPoint().catch((e)=>{\r\n        return Promise.resolve({innerError:(e||'').toString()});\r\n    });\r\n    if('innerError' in xyz){\r\n        return fault(res,'getPoint','getPoint方法内部发生错误',{id,innerError:xyz.innerError});\r\n    }\r\n    return succeed(res,'getPoint',xyz);\r\n}\r\n\r\nasync function moveToPoint(res,id,params){\r\n    logger.log('收到获取球机移动到指定点申请',{id});\r\n    let ipc=await IPCFactory.getIPC(id).catch(()=>{\r\n        return Promise.resolve(null);\r\n    });\r\n    if(!ipc)return fault(res,'moveToPoint','请求的摄像头不存在',{id});\r\n    let point=JSON.parse(params.point||\"{x:-1}\");\r\n    if(point.x===-1) return fault(res,'错误的坐标');\r\n    ipc.moveToPoint(point.x,point.y,point.z).then(()=>{\r\n        return succeed(res,'moveToPoint');\r\n    }).catch((e)=>{\r\n        return fault(res,'moveToPoint','moveToPoint方法内部发生错误',{id,innerError:(e||'').toString()});\r\n    });\r\n}\r\n\r\nasync function alarm(res,id){\r\n    logger.log('收到到拉起报警申请',{id});\r\n    let ipc=await IPCFactory.getIPC(id).catch(()=>{\r\n        return Promise.resolve(null);\r\n    });\r\n    if(!ipc)return fault(res,'alarm','请求的摄像头不存在',{id});\r\n    ipc.alarm().then(()=>{\r\n        return succeed(res,'alarm');\r\n    }).catch((e)=>{\r\n        return fault(res,'alarm','alarm方法内部发生错误',{id,innerError:(e||'').toString()});\r\n    });\r\n}\r\n\r\nasync function stopAlarm(res,id){\r\n    logger.log('收到消除警报申请',{id});\r\n    let ipc=await IPCFactory.getIPC(id).catch(()=>{\r\n        return Promise.resolve(null);\r\n    });\r\n    if(!ipc)return fault(res,'stopAlarm','请求的摄像头不存在',{id});\r\n    ipc.stopAlarm().then(()=>{\r\n        return succeed(res,'stopAlarm');\r\n    }).catch((e)=>{\r\n        return fault(res,'stopAlarm','stopAlarm方法内部发生错误',{id,innerError:(e||'').toString()});\r\n    });\r\n}\r\n\r\nconst server=http.createServer();\r\n/*server.on('upgrade', (req, socket, head) => {\r\n    console.log('upgrade');\r\n});*/\r\n\r\nserver.on('request',(req,res)=>{\r\n    let uri=url.parse(req.url,true);\r\n    let paths=_.trim(uri.pathname,'/').split('/').concat(['','','','']);\r\n    if(paths[0]!=='ipc') {\r\n        logger.warn('未知的请求',{uri});\r\n        return;\r\n    }\r\n    logger.log('收到请求',{uri});\r\n    //res.setHeader('Connection','Upgrade');\r\n    //res.setHeader('Upgrade','websocket');\r\n    res.setHeader('Content-Type','application/json; charset=utf-8');\r\n    res.setHeader('Access-Control-Allow-Origin','*');\r\n    res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type,Content-Length, Authorization, Accept,X-Requested-With\");\r\n    res.setHeader(\"Access-Control-Allow-Methods\",\"PUT,POST,GET,DELETE,OPTIONS\");\r\n    res.setHeader(\"X-Powered-By\",' 3.2.1');\r\n    let id=paths[1]-0;\r\n    let fun=paths[2];\r\n    let index;\r\n    if((index=['live','stoparrchive','ptz','freeptz','arrchive','getpoint','movetopoint','alarm', 'stopalarm'].indexOf(_.toLower(fun)))===-1){\r\n        res.statusCode = 404;\r\n        return res.end();\r\n    }\r\n    if(index===0){\r\n        return play(res,id);\r\n    }\r\n    if(index===1){\r\n        return stopArrchive(res,id);\r\n    }\r\n    if(index===2){\r\n        //ptz/id/ptz/zoomAdd?position\r\n        return ptz(res,id,paths[3],uri.query);\r\n    }\r\n    if(index===3){\r\n        return freePTZ(res,id,uri.query);\r\n    }\r\n    if(index===4){\r\n        return arrchive(res,id,paths[3]);\r\n    }\r\n    if(index===5){\r\n        return getPoint(res,id);\r\n    }\r\n    if(index===6){\r\n        return moveToPoint(res,id,uri.query);\r\n    }\r\n    if(index===7){\r\n        return alarm(res,id)\r\n    }\r\n    if(index===8){\r\n        return stopAlarm(res,id);\r\n    }\r\n    logger.warn('未知的方法请求',{fun,uri});\r\n});\r\n\r\nasync function listen() {\r\n    let _port=await getPort();\r\n    server.listen(_port);\r\n    port=_port;\r\n}\r\n\r\nserver.on('listening',()=>{\r\n    store==='db'&&connect();\r\n    Parser(logger,'ipc_server_child.js',{port:server.address().port});\r\n    logger.log('摄像头直播流进程启动',{processID:process.pid,port:port});\r\n    send({type:'listening',port:port});\r\n});\r\n\r\nserver.on('error',(err)=>{\r\n    if(err.code==='EACCES'||err.code==='EADDRINUSE'){\r\n        listen();\r\n    }\r\n    console.error({source:'ipc_server_child.js',desc:(err||'').toString()});\r\n});\r\n\r\nlisten().catch();\r\n\r\nfunction createID() {\r\n    const hash = crypto.createHash('md5');\r\n    hash.update(new Date().getTime().toString());\r\n    return hash.digest('hex');\r\n}\r\n\r\nexports=module.exports={\r\n    server\r\n};"]}