{"version":3,"sources":["../../src/servers/ipc_video_persistence.js"],"names":["config","global","server_config","require","root","_","mkdirp","path","stringFormat","Persistence","options","pathTempl","imageTempl","videoTempl","extend","get","_index","template","prefix","date","Date","indexOf","getFullYear","padStart","getMonth","getDate","getHours","getMinutes","getSeconds","postfix","resolve","_path","_unTemplate","__path","ret","sync","exports","module"],"mappings":";;;;;;AACA;;;AAGA,IAAMA,SAAOC,OAAOC,aAAP,IAAsBC,QAAQ,kBAAR,CAAnC;AACA,IAAMC,OAAKJ,OAAOI,IAAlB;AACA,IAAMC,IAAEF,QAAQ,QAAR,CAAR;AACA,IAAMG,SAAOH,QAAQ,QAAR,CAAb;AACA,IAAMI,OAAOJ,QAAQ,MAAR,CAAb;AACA,IAAMK,eAAaL,QAAQ,iBAAR,CAAnB;;IAEMM,W;AACF,yBAAYC,OAAZ,EAAoB;AAAA;;AAChB,aAAKA,OAAL,GAAa;AACTC,uBAAU,+BADD;AAETC,wBAAW,mCAFF;AAGTC,wBAAW;AAHF,SAAb;AAKAR,UAAES,MAAF,CAAS,KAAKJ,OAAd,EAAsBL,EAAEU,GAAF,CAAMf,MAAN,EAAa,aAAb,EAA2B,IAA3B,CAAtB,EAAuDU,OAAvD;AACA,aAAKM,MAAL,GAAY,CAAZ;AACH;;;;oCAEWC,Q,EAASC,M,EAAO;AACxB,gBAAIC,OAAK,IAAIC,IAAJ,EAAT;AACA,gBAAGH,SAASI,OAAT,CAAiB,QAAjB,IAA2B,CAAC,CAA/B,EAAiC;AAC7B,qBAAKL,MAAL;AACH;AACD,mBAAOR,aAAaS,QAAb,EAAsB;AACzB,0BAASC,MADgB;AAEzB,sBAAKC,KAAKG,WAAL,KAAmB,GAFC;AAGzB,wBAAOH,KAAKG,WAAL,EAHkB;AAIzB,sBAAKjB,EAAEkB,QAAF,CAAW,MAAIJ,KAAKK,QAAL,KAAgB,CAApB,CAAX,EAAkC,CAAlC,EAAoC,CAApC,CAJoB;AAKzB,sBAAKnB,EAAEkB,QAAF,CAAW,KAAGJ,KAAKM,OAAL,EAAd,EAA6B,CAA7B,EAA+B,CAA/B,CALoB;AAMzB,sBAAKpB,EAAEkB,QAAF,CAAW,KAAGJ,KAAKO,QAAL,EAAd,EAA8B,CAA9B,EAAgC,CAAhC,CANoB;AAOzB,sBAAKrB,EAAEkB,QAAF,CAAW,KAAGJ,KAAKQ,UAAL,EAAd,EAAgC,CAAhC,EAAkC,CAAlC,CAPoB;AAQzB,sBAAKtB,EAAEkB,QAAF,CAAW,KAAGJ,KAAKS,UAAL,EAAd,EAAgC,CAAhC,EAAkC,CAAlC,CARoB;AASzB,wBAAOvB,EAAEkB,QAAF,CAAW,KAAG,KAAKP,MAAnB,EAA0B,CAA1B,EAA4B,CAA5B;AATkB,aAAtB,CAAP;AAWH;;;oCAWiC;AAAA,gBAAxBE,MAAwB,uEAAjB,EAAiB;AAAA,gBAAdW,OAAc,uEAAN,KAAM;;AAC9B,mBAAOtB,KAAKuB,OAAL,CAAa,KAAKC,KAAlB,EAAwB,KAAKC,WAAL,CAAiB,KAAKtB,OAAL,CAAaE,UAA9B,EAAyCM,MAAzC,CAAxB,IAA0E,GAA1E,GAA8EW,OAArF;AACH;;;oCAEiC;AAAA,gBAAxBX,MAAwB,uEAAjB,EAAiB;AAAA,gBAAdW,OAAc,uEAAN,KAAM;;AAC9B,mBAAOtB,KAAKuB,OAAL,CAAa,KAAKC,KAAlB,EAAwB,KAAKC,WAAL,CAAiB,KAAKtB,OAAL,CAAaG,UAA9B,EAAyCK,MAAzC,CAAxB,IAA0E,GAA1E,GAA8EW,OAArF;AACH;;;4BAfU;AACP,gBAAG,KAAKI,MAAR,EAAe;AACX,uBAAO,KAAKA,MAAZ;AACH;AACD,gBAAIC,MAAI3B,KAAKuB,OAAL,CAAa1B,IAAb,EAAkB,KAAK4B,WAAL,CAAiB,KAAKtB,OAAL,CAAaC,SAA9B,CAAlB,CAAR;AACAL,mBAAO6B,IAAP,CAAYD,GAAZ;AACA,mBAAO,KAAKD,MAAL,GAAYC,GAAnB;AACH;;;;;;AAWLE,UAAQC,OAAOD,OAAP,GAAe3B,WAAvB","file":"ipc_video_persistence.js","sourcesContent":["\r\n/**\r\n * Created by Luky on 2017/9/4.\r\n */\r\nconst config=global.server_config||require('../config/config');\r\nconst root=config.root;\r\nconst _=require('lodash');\r\nconst mkdirp=require('mkdirp');\r\nconst path = require('path');\r\nconst stringFormat=require('string-template');\r\n\r\nclass Persistence{\r\n    constructor(options){\r\n        this.options={\r\n            pathTempl:'../assets/monitors/{yyyy}{mm}',\r\n            imageTempl:'{dd}-{hh}{mi}{ss}-{iter}-{prefix}',\r\n            videoTempl:'{dd}-{hh}{mi}{ss}-{prefix}',\r\n        };\r\n        _.extend(this.options,_.get(config,'persistence',null),options);\r\n        this._index=0;\r\n    }\r\n\r\n    _unTemplate(template,prefix){\r\n        let date=new Date();\r\n        if(template.indexOf('{iter}')>-1){\r\n            this._index++;\r\n        }\r\n        return stringFormat(template,{\r\n            'prefix':prefix,\r\n            'yy':date.getFullYear()%100,\r\n            'yyyy':date.getFullYear(),\r\n            'mm':_.padStart(''+(date.getMonth()+1),2,0) ,\r\n            'dd':_.padStart(''+date.getDate(),2,0),\r\n            'hh':_.padStart(''+date.getHours(),2,0),\r\n            'mi':_.padStart(''+date.getMinutes(),2,0),\r\n            'ss':_.padStart(''+date.getSeconds(),2,0),\r\n            'iter':_.padStart(''+this._index,3,0)\r\n        });\r\n    }\r\n\r\n    get _path(){\r\n        if(this.__path){\r\n            return this.__path;\r\n        }\r\n        let ret=path.resolve(root,this._unTemplate(this.options.pathTempl));\r\n        mkdirp.sync(ret);\r\n        return this.__path=ret;\r\n    }\r\n\r\n    imagePath(prefix='',postfix='jpg'){\r\n        return path.resolve(this._path,this._unTemplate(this.options.imageTempl,prefix))+'.'+postfix;\r\n    }\r\n\r\n    videoPath(prefix='',postfix='flv'){\r\n        return path.resolve(this._path,this._unTemplate(this.options.videoTempl,prefix))+'.'+postfix;\r\n    }\r\n}\r\n\r\nexports=module.exports=Persistence;"]}