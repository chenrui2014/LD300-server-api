{"version":3,"sources":["../../src/servers/startup.js"],"names":["Host","require","HostServer","IPCServer","Parser","config","global","server_config","_","projectName","get","runModeBS","MessengerServer","MessengerServerSocket","MessengerServerBase","getInterface","StartUp","_host_state_changed","_onHostStateChanged","bind","_push_server_new_client","_onNewClient","evt","log","innerEvent","_messengerServer","notifyHostStateChanged","client","_hostServer","notifyHostsState","hostsState","stop","hostServer","start","catch","e","error","innerError","Promise","reject","messengerServer","on","Events","StateChanged","newClient","removeListener","_ipcServer","exports","module"],"mappings":"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","file":"startup.js","sourcesContent":["/**\r\n * Created by Luky on 2017/8/17.\r\n */\r\nconst Host=require('../host/host');\r\nconst HostServer=require('./host_server');\r\nconst IPCServer=require('./ipc_server_master');\r\nconst {Parser}=require('../log/log');\r\nconst config=global.server_config||require('../config/config');\r\nconst _=require('lodash');\r\nconst projectName=_.get(config,'runMode.project','');\r\nconst runModeBS=_.get(config,'runMode.type','BS')==='BS';\r\nconst MessengerServer=require('./messenger_server_http_socket');\r\nconst MessengerServerSocket=require('./messenger_server_socket');\r\nconst MessengerServerBase=require('./messenger_server');\r\nconst {getInterface}=require('./interfaces/addin');\r\n\r\nclass StartUp{\r\n    constructor(){\r\n        Parser(this,'startup.js');\r\n        this._host_state_changed = this._onHostStateChanged.bind(this);\r\n        this._push_server_new_client = this._onNewClient.bind(this);\r\n    }\r\n\r\n    _onHostStateChanged(evt){\r\n        this.log('尝试向前台同步主机状态',{innerEvent:evt});\r\n        this._messengerServer&&this._messengerServer.notifyHostStateChanged(evt);\r\n    }\r\n\r\n    _onNewClient(client){\r\n        this.log('尝试向新连入客户端同步主机状态');\r\n        this._hostServer&&this._messengerServer.notifyHostsState(client,this._hostServer.hostsState);\r\n    }\r\n\r\n    async start() {\r\n        this.stop();\r\n        let hostServer = new HostServer();\r\n        //为了不遗漏数据，先启动服务，后启动状态推送服务\r\n        await hostServer.start().catch((e)=>{\r\n            this.error('主机服务启动失败',{innerError:e});\r\n            return Promise.reject(e);\r\n        });\r\n        this._hostServer=hostServer;\r\n        let messengerServer = runModeBS?\r\n            new MessengerServer(hostServer):\r\n            new MessengerServerSocket(hostServer,null,getInterface(projectName));\r\n        hostServer.on(Host.Events.StateChanged, this._host_state_changed);\r\n        messengerServer.on(MessengerServerBase.Events.newClient, this._push_server_new_client);\r\n        await messengerServer.start().catch(()=>{\r\n            hostServer.removeListener(Host.Events.StateChanged, this._host_state_changed);\r\n            messengerServer.removeListener(MessengerServerBase.Events.newClient, this._push_server_new_client);\r\n            this._hostServer=null;\r\n            this.error('消息服务启动失败',{innerError:e});\r\n            return Promise.reject(e);\r\n        });\r\n        this._messengerServer=messengerServer;\r\n        if(runModeBS){\r\n            this._ipcServer=new IPCServer();\r\n            await this._ipcServer.start().catch();\r\n        }\r\n        this.log('服务已启动');\r\n    }\r\n\r\n    stop(){\r\n        if(this._hostServer){\r\n            this._hostServer.removeListener(Host.Events.StateChanged,this._host_state_changed);\r\n            this._hostServer.stop();\r\n            this._hostServer=null;\r\n        }\r\n\r\n        if(this._messengerServer){\r\n            this._messengerServer.removeListener(MessengerServerBase.Events.newClient, this._push_server_new_client);\r\n            this._messengerServer=null;\r\n        }\r\n\r\n        if(this._ipcServer){\r\n            this._ipcServer.stop();\r\n            this._ipcServer=null;\r\n        }\r\n        this.log('服务已停止');\r\n    }\r\n}\r\n\r\nexports=module.exports=StartUp;"]}